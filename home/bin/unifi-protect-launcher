#!/usr/bin/env bash
# Launch Unifi Protect in isolated Chromium profile with 1Password

PROFILE="$HOME/.config/chromium-unifi"
URL="https://unifi.ui.com/consoles/6C63F8E8542600000000094888ED0000000009C882AC000000006876CE89:747021346/protect/dashboard/all"

ONEPASS_EXT=$(find ~/.config/chromium/Default/Extensions/aeblfdkhhhdcdjpifhhbdiojplfjncoa -maxdepth 1 -mindepth 1 -type d 2>/dev/null | head -1)

window=$(hyprctl clients -j | jq -r '.[] | select(.title | test("Protect"; "i")) | select(.class | test("unifi"; "i")) | .address' | head -1)

if [[ -n "$window" ]]; then
    hyprctl dispatch focuswindow "address:$window"
else
    if [[ -n "$ONEPASS_EXT" ]]; then
        chromium --user-data-dir="$PROFILE" --load-extension="$ONEPASS_EXT" --disable-popup-blocking --app="$URL" &
    else
        chromium --user-data-dir="$PROFILE" --disable-popup-blocking --app="$URL" &
    fi
fi
