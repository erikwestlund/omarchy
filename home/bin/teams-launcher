#!/usr/bin/env bash
# Launch Teams in isolated Chromium profile with 1Password

PROFILE="$HOME/.config/chromium-teams"
URL="https://teams.microsoft.com"

# Find 1Password extension (latest version)
ONEPASS_BASE="$HOME/.config/chromium/Default/Extensions/aeblfdkhhhdcdjpifhhbdiojplfjncoa"
ONEPASS_EXT=""
if [[ -d "$ONEPASS_BASE" ]]; then
    ONEPASS_VERSION=$(ls -1 "$ONEPASS_BASE" 2>/dev/null | sort -V | tail -1)
    if [[ -n "$ONEPASS_VERSION" ]]; then
        ONEPASS_EXT="$ONEPASS_BASE/$ONEPASS_VERSION"
    fi
fi

window=$(hyprctl clients -j | jq -r '.[] | select(.class | test("teams"; "i")) | .address' | head -1)

if [[ -n "$window" ]]; then
    hyprctl dispatch focuswindow "address:$window"
else
    chromium_args=(--user-data-dir="$PROFILE" --disable-popup-blocking --app="$URL")
    if [[ -n "$ONEPASS_EXT" ]]; then
        chromium_args+=(--load-extension="$ONEPASS_EXT")
    fi
    chromium "${chromium_args[@]}" &
fi
