#!/usr/bin/env bash
# Launch Teams in isolated Chromium profile with 1Password

PROFILE="$HOME/.config/chromium-teams"
URL="https://teams.microsoft.com"

find_window_for_profile() {
    local profile="$1"
    local result=""

    while IFS=$'\t' read -r address workspace pid; do
        [[ "$pid" =~ ^[0-9]+$ ]] || continue
        [[ -r "/proc/$pid/cmdline" ]] || continue

        if tr '\0' '\n' < "/proc/$pid/cmdline" | grep -Fxq -- "--user-data-dir=$profile"; then
            result="$address"$'\t'"$workspace"
            break
        fi
    done < <(hyprctl clients -j | jq -r '.[] | "\(.address)\t\(.workspace.name // "")\t\(.pid // "")"')

    if [[ -n "$result" ]]; then
        printf '%s\n' "$result"
        return 0
    fi

    return 1
}

# Find 1Password extension (latest version)
ONEPASS_BASE="$HOME/.config/chromium/Default/Extensions/aeblfdkhhhdcdjpifhhbdiojplfjncoa"
ONEPASS_EXT=""
if [[ -d "$ONEPASS_BASE" ]]; then
    ONEPASS_VERSION=$(ls -1 "$ONEPASS_BASE" 2>/dev/null | sort -V | tail -1)
    if [[ -n "$ONEPASS_VERSION" ]]; then
        ONEPASS_EXT="$ONEPASS_BASE/$ONEPASS_VERSION"
    fi
fi

window_info=$(find_window_for_profile "$PROFILE")

if [[ -z "$window_info" ]]; then
    window_info=$(hyprctl clients -j | jq -r '.[] | select((.class | test("teams"; "i")) or (.title | test("teams"; "i"))) | "\(.address)\t\(.workspace.name // "")"' | head -1)
fi

if [[ -n "$window_info" ]]; then
    window="${window_info%%$'\t'*}"
    window_workspace="${window_info#*$'\t'}"

    if [[ "$window_workspace" == special:* ]]; then
        active_workspace=$(hyprctl activeworkspace -j | jq -r '.name // "1"')
        hyprctl dispatch movetoworkspacesilent "$active_workspace,address:$window"
    fi

    hyprctl dispatch focuswindow "address:$window"
else
    chromium_args=(--user-data-dir="$PROFILE" --disable-popup-blocking --app="$URL")
    if [[ -n "$ONEPASS_EXT" ]]; then
        chromium_args+=(--load-extension="$ONEPASS_EXT")
    fi
    chromium "${chromium_args[@]}" &
fi
