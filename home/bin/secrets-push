#!/bin/bash
# Encrypt and push secrets to B2
set -e

CONFIG="$HOME/.config/secrets/config"
SECRETS_DIR="$HOME/.secrets"
CACHE_DIR="$HOME/.cache/secrets-encrypted"

if [[ ! -f "$CONFIG" ]]; then
    echo "Error: Config not found at $CONFIG"
    echo "Run 'ansible-playbook playbook.yml --tags secrets' first to deploy credentials"
    exit 1
fi

source "$CONFIG"

# Validate config
if [[ -z "$B2_KEY_ID" || -z "$B2_APP_KEY" || -z "$B2_BUCKET" || -z "$AGE_PUBLIC_KEY" ]]; then
    echo "Error: Missing required config variables"
    exit 1
fi

if [[ ! -d "$SECRETS_DIR" ]]; then
    echo "Error: Secrets directory not found at $SECRETS_DIR"
    exit 1
fi

echo "Encrypting secrets..."
rm -rf "$CACHE_DIR"
mkdir -p "$CACHE_DIR"

# Encrypt all files in secrets directory
find "$SECRETS_DIR" -type f | while read -r secret_file; do
    # Get relative path
    rel_path="${secret_file#$SECRETS_DIR/}"
    output_path="$CACHE_DIR/${rel_path}.age"

    # Create parent directory
    mkdir -p "$(dirname "$output_path")"

    # Encrypt with public key
    age -r "$AGE_PUBLIC_KEY" "$secret_file" > "$output_path"
    echo "  Encrypted: $rel_path"
done

echo "Syncing to B2..."

# Configure rclone on the fly
export RCLONE_CONFIG_B2_TYPE=b2
export RCLONE_CONFIG_B2_ACCOUNT="$B2_KEY_ID"
export RCLONE_CONFIG_B2_KEY="$B2_APP_KEY"

# Sync to B2
rclone sync "$CACHE_DIR/" "b2:$B2_BUCKET/secrets/" --progress

echo "Done. Secrets pushed to B2."
