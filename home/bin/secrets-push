#!/bin/bash
# Encrypt and push secrets to B2
set -e

CONFIG="$HOME/.config/secrets/config"
SECRETS_DIR="$HOME/.secrets"
VAULT_FILE="$HOME/Omarchy/ansible/vault/secrets.yml"
CACHE_DIR="$HOME/.cache/secrets-encrypted"
PROJECTS_DIR="$HOME/Projects"
ENV_CACHE_DIR="$HOME/.cache/secrets-env-encrypted"
VAULT_CACHE_DIR="$HOME/.cache/secrets-vault-encrypted"

if [[ ! -f "$CONFIG" ]]; then
    echo "Error: Config not found at $CONFIG"
    echo "Run 'ansible-playbook playbook.yml --tags secrets' first to deploy credentials"
    exit 1
fi

source "$CONFIG"

# Validate config
if [[ -z "$B2_KEY_ID" || -z "$B2_APP_KEY" || -z "$B2_BUCKET" || -z "$AGE_PUBLIC_KEY" ]]; then
    echo "Error: Missing required config variables"
    exit 1
fi

if [[ ! -d "$SECRETS_DIR" ]]; then
    echo "Error: Secrets directory not found at $SECRETS_DIR"
    exit 1
fi

echo "Encrypting secrets..."
rm -rf "$CACHE_DIR"
mkdir -p "$CACHE_DIR"

# Encrypt all files in secrets directory
find "$SECRETS_DIR" -type f | while read -r secret_file; do
    # Get relative path
    rel_path="${secret_file#$SECRETS_DIR/}"
    output_path="$CACHE_DIR/${rel_path}.age"

    # Create parent directory
    mkdir -p "$(dirname "$output_path")"

    # Encrypt with public key
    age -r "$AGE_PUBLIC_KEY" "$secret_file" > "$output_path"
    echo "  Encrypted: $rel_path"
done

# Encrypt ansible vault file if it exists
if [[ -f "$VAULT_FILE" ]]; then
    age -r "$AGE_PUBLIC_KEY" "$VAULT_FILE" > "$CACHE_DIR/ansible-vault.yml.age"
    echo "  Encrypted: ansible-vault.yml"
fi

# Encrypt .env files from Projects directory
if [[ -d "$PROJECTS_DIR" ]]; then
    echo "Encrypting .env files from Projects..."
    rm -rf "$ENV_CACHE_DIR"
    mkdir -p "$ENV_CACHE_DIR"

    find "$PROJECTS_DIR" -name ".env*" -type f \
        ! -name "*.example" \
        ! -name ".envrc" \
        ! -path "*/vendor/*" \
        ! -path "*/storage/*" \
        ! -path "*/tmp/*" \
        ! -path "*/temp/*" \
        2>/dev/null | while read -r env_file; do
        rel_path="${env_file#$PROJECTS_DIR/}"
        output_path="$ENV_CACHE_DIR/${rel_path}.age"
        mkdir -p "$(dirname "$output_path")"
        age -r "$AGE_PUBLIC_KEY" "$env_file" > "$output_path"
        echo "  Encrypted: $rel_path"
    done
fi

# Encrypt vault/secrets.yml files from Projects directory
if [[ -d "$PROJECTS_DIR" ]]; then
    echo "Encrypting project vault files..."
    rm -rf "$VAULT_CACHE_DIR"
    mkdir -p "$VAULT_CACHE_DIR"

    find "$PROJECTS_DIR" -path "*/vault/secrets.yml" -type f 2>/dev/null | while read -r vault_file; do
        rel_path="${vault_file#$PROJECTS_DIR/}"
        output_path="$VAULT_CACHE_DIR/${rel_path}.age"
        mkdir -p "$(dirname "$output_path")"
        age -r "$AGE_PUBLIC_KEY" "$vault_file" > "$output_path"
        echo "  Encrypted: $rel_path"
    done
fi

# Encrypt .kamal secrets and SSL certificates from Projects directory
KAMAL_CACHE_DIR="$HOME/.cache/secrets-kamal-encrypted"
if [[ -d "$PROJECTS_DIR" ]]; then
    echo "Encrypting .kamal secrets and SSL..."
    rm -rf "$KAMAL_CACHE_DIR"
    mkdir -p "$KAMAL_CACHE_DIR"

    # Find .kamal/secrets* files (secrets, secrets-common, etc.)
    find "$PROJECTS_DIR" -path "*/.kamal/secrets*" -type f ! -name "*.example" 2>/dev/null | while read -r kamal_file; do
        rel_path="${kamal_file#$PROJECTS_DIR/}"
        output_path="$KAMAL_CACHE_DIR/${rel_path}.age"
        mkdir -p "$(dirname "$output_path")"
        age -r "$AGE_PUBLIC_KEY" "$kamal_file" > "$output_path"
        echo "  Encrypted: $rel_path"
    done

    # Find .kamal/ssl/* files (certificates and keys)
    find "$PROJECTS_DIR" -path "*/.kamal/ssl/*" -type f 2>/dev/null | while read -r ssl_file; do
        rel_path="${ssl_file#$PROJECTS_DIR/}"
        output_path="$KAMAL_CACHE_DIR/${rel_path}.age"
        mkdir -p "$(dirname "$output_path")"
        age -r "$AGE_PUBLIC_KEY" "$ssl_file" > "$output_path"
        echo "  Encrypted: $rel_path"
    done
fi

echo "Syncing to B2..."

# Configure rclone on the fly
export RCLONE_CONFIG_B2_TYPE=b2
export RCLONE_CONFIG_B2_ACCOUNT="$B2_KEY_ID"
export RCLONE_CONFIG_B2_KEY="$B2_APP_KEY"

# Sync to B2
rclone sync "$CACHE_DIR/" "b2:$B2_BUCKET/secrets/" --progress

# Sync .env files to B2 (only if local is newer)
if [[ -d "$ENV_CACHE_DIR" ]] && [[ -n "$(ls -A "$ENV_CACHE_DIR" 2>/dev/null)" ]]; then
    echo "Syncing .env files to B2 (only if newer)..."
    rclone copy "$ENV_CACHE_DIR/" "b2:$B2_BUCKET/projects-env/" --update --progress
fi

# Sync project vault files to B2 (only if local is newer)
if [[ -d "$VAULT_CACHE_DIR" ]] && [[ -n "$(ls -A "$VAULT_CACHE_DIR" 2>/dev/null)" ]]; then
    echo "Syncing project vault files to B2 (only if newer)..."
    rclone copy "$VAULT_CACHE_DIR/" "b2:$B2_BUCKET/projects-vault/" --update --progress
fi

# Sync .kamal secrets and SSL to B2 (only if local is newer)
if [[ -d "$KAMAL_CACHE_DIR" ]] && [[ -n "$(ls -A "$KAMAL_CACHE_DIR" 2>/dev/null)" ]]; then
    echo "Syncing .kamal secrets to B2 (only if newer)..."
    rclone copy "$KAMAL_CACHE_DIR/" "b2:$B2_BUCKET/projects-kamal/" --update --progress
fi

echo "Done. Secrets pushed to B2."
