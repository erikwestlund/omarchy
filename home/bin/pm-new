#!/bin/bash
# Interactive project management scaffolding
# Creates tmux launcher and aliases via Ansible

set -e

OMARCHY_DIR="$HOME/Omarchy"
PROJECTS_DIR="$HOME/Projects"
PM_DIR="$OMARCHY_DIR/projects"

# Convert to kebab-case: "My Cool App" -> "my-cool-app"
to_kebab() {
    echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//'
}

# Find next available port for a service by reading projects.yml
# Usage: next_port SERVICE_NAME DEFAULT_BASE
# Returns highest allocated port + 1, or DEFAULT_BASE if none found
next_port() {
    local service=$1
    local default=$2
    local projects_file="$OMARCHY_DIR/config/projects/projects.yml"
    # Extract highest port for this service from projects.yml (number on same line as service key)
    local max_port=$(grep "[[:space:]]${service}:" "$projects_file" 2>/dev/null | grep -oE '[0-9]+$' | sort -n | tail -1)
    if [ -n "$max_port" ]; then
        echo $((max_port + 1))
    else
        echo $default
    fi
}

echo "=== New Project Setup ==="
echo ""

# 1. Project display name
read -p "Project name (e.g., 'UK Biobank'): " DISPLAY_NAME
if [ -z "$DISPLAY_NAME" ]; then
    echo "Error: Project name is required"
    exit 1
fi

KEBAB_NAME=$(to_kebab "$DISPLAY_NAME")

# 2. PM dir name
read -p "Project management dir name [$KEBAB_NAME]: " PM_NAME
PM_NAME="${PM_NAME:-$KEBAB_NAME}"

if [ -d "$PM_DIR/$PM_NAME" ]; then
    echo "Error: Project '$PM_NAME' already exists in ~/Omarchy/projects"
    exit 1
fi

# 3. Project type (ask early to set context)
echo ""
echo "Project types:"
echo "  1) utility  - Basic (default)"
echo "  2) laravel  - Laravel/PHP"
echo "  3) python   - Python"
echo "  4) rstats   - R/Statistics"
echo ""
read -p "Type [1-4, default=1]: " TYPE_CHOICE

case "$TYPE_CHOICE" in
    2) PROJECT_TYPE="laravel" ;;
    3) PROJECT_TYPE="python" ;;
    4) PROJECT_TYPE="rstats" ;;
    *) PROJECT_TYPE="utility" ;;
esac

# 4. Editor choice
echo ""
echo "Preferred editor:"
echo "  1) vscode   - VS Code (default)"
echo "  2) positron - Positron"
echo "  3) neovim   - Neovim"
echo ""
read -p "Editor [1-3, default=1]: " EDITOR_CHOICE

case "$EDITOR_CHOICE" in
    2) PROJECT_EDITOR="positron" ;;
    3) PROJECT_EDITOR="neovim" ;;
    *) PROJECT_EDITOR="vscode" ;;
esac

# 5. Docker compose?
echo ""
read -p "Use Docker Compose? [y/N]: " USE_DOCKER
if [[ "$USE_DOCKER" =~ ^[Yy] ]]; then
    DOCKER_COMPOSE=true
else
    DOCKER_COMPOSE=false
fi

# 5b. Auto-assign ports for Laravel projects with Docker
if [ "$PROJECT_TYPE" = "laravel" ] && [ "$DOCKER_COMPOSE" = true ]; then
    # Base ports match projects.yml convention (line 7-10)
    PORT_VITE=$(next_port vite 5173)
    PORT_NGINX=$(next_port nginx 8010)
    PORT_POSTGRES=$(next_port postgres 5440)
    PORT_REDIS=$(next_port redis 6390)
    PORT_MEILISEARCH=$(next_port meilisearch 7700)
    PORT_MINIO_API=$(next_port minio_api 9010)
    PORT_MINIO_CONSOLE=$(next_port minio_console 9011)
    PORT_MAILPIT_SMTP=$(next_port mailpit_smtp 1030)
    PORT_MAILPIT_WEB=$(next_port mailpit_web 8030)
fi

# 6. Default workspace
echo ""
read -p "Default workspace [1]: " DEFAULT_WS
DEFAULT_WS="${DEFAULT_WS:-1}"

# 6b. View URL (for web projects)
VIEW_URL=""
if [ "$PROJECT_TYPE" = "laravel" ]; then
    echo ""
    echo "Laravel projects can open a browser alongside the editor."
    read -p "View URL (e.g., 'http://myapp.test/admin', or Enter to skip): " VIEW_URL
fi

# 7. Link to project directory?
PROJECT_PATH=""
GITHUB_REPO=""
CREATE_EMPTY_DIR=""
echo ""
echo "Link to a project directory in ~/Projects/$KEBAB_NAME?"
echo "  - You can choose a different directory name if needed"
echo "  - Can clone from GitHub or create empty directory"
echo ""
read -p "Link to project? [Y/n]: " LINK_PROJECT
if [[ ! "$LINK_PROJECT" =~ ^[Nn] ]]; then
    # Look for ~/Projects/{kebab}
    if [ -d "$PROJECTS_DIR/$KEBAB_NAME" ]; then
        read -p "Found ~/Projects/$KEBAB_NAME - use this? [Y/n]: " USE_FOUND
        if [[ ! "$USE_FOUND" =~ ^[Nn] ]]; then
            PROJECT_PATH="$PROJECTS_DIR/$KEBAB_NAME"
        else
            read -p "Project dir name in ~/Projects: " CUSTOM_DIR
            if [ -n "$CUSTOM_DIR" ]; then
                if [ -d "$PROJECTS_DIR/$CUSTOM_DIR" ]; then
                    PROJECT_PATH="$PROJECTS_DIR/$CUSTOM_DIR"
                else
                    echo "Directory doesn't exist: $PROJECTS_DIR/$CUSTOM_DIR"
                    exit 1
                fi
            fi
        fi
    else
        echo "~/Projects/$KEBAB_NAME doesn't exist."
        read -p "Create a project directory? [Y/n]: " CREATE_DIR
        if [[ ! "$CREATE_DIR" =~ ^[Nn] ]]; then
            read -p "Clone from GitHub? (e.g., 'user/repo') or Enter for empty dir: " GITHUB_REPO
            if [ -n "$GITHUB_REPO" ]; then
                read -p "Directory name [$KEBAB_NAME]: " DIR_NAME
                DIR_NAME="${DIR_NAME:-$KEBAB_NAME}"
                PROJECT_PATH="$PROJECTS_DIR/$DIR_NAME"
            else
                read -p "Directory name [$KEBAB_NAME]: " DIR_NAME
                DIR_NAME="${DIR_NAME:-$KEBAB_NAME}"
                PROJECT_PATH="$PROJECTS_DIR/$DIR_NAME"
                CREATE_EMPTY_DIR="$PROJECT_PATH"
            fi
        fi
    fi
fi

# 8. Alias
echo ""
echo "Alias creates: l{alias} (launch), k{alias} (kill), tm{alias} (tmux), b{alias} (bootstrap), pm{alias} (PM dir), {alias} (project dir)"
echo "              vs{alias} (VS Code), nv{alias} (NeoVim), p{alias} (Positron)"
if [ "$DOCKER_COMPOSE" = true ]; then
    echo "              d{alias} (docker up), dd{alias} (docker down)"
fi
read -p "Alias (e.g., 'hl' creates lhl, khl, tmhl, bhl, pmhl, hl): " PROJECT_ALIAS
if [ -z "$PROJECT_ALIAS" ]; then
    echo "Error: Alias is required"
    exit 1
fi

# Summary
echo ""
echo "=== Summary ==="
echo "Name:     $DISPLAY_NAME"
echo "Type:     $PROJECT_TYPE"
echo "Editor:   $PROJECT_EDITOR"
echo "Docker:   $DOCKER_COMPOSE"
echo "Default WS: $DEFAULT_WS"
if [ -n "$VIEW_URL" ]; then
    echo "View URL: $VIEW_URL"
fi
if [ "$PROJECT_TYPE" = "laravel" ] && [ "$DOCKER_COMPOSE" = true ]; then
    echo "Ports:    vite=$PORT_VITE nginx=$PORT_NGINX postgres=$PORT_POSTGRES redis=$PORT_REDIS"
    echo "          minio=$PORT_MINIO_API/$PORT_MINIO_CONSOLE mailpit=$PORT_MAILPIT_SMTP/$PORT_MAILPIT_WEB"
fi
echo "PM dir:   ~/Omarchy/projects/$PM_NAME"
if [ -n "$PROJECT_PATH" ]; then
    if [ -n "$GITHUB_REPO" ]; then
        echo "Project:  $PROJECT_PATH (clone from github.com/$GITHUB_REPO)"
    else
        echo "Project:  $PROJECT_PATH"
    fi
    echo "Aliases:  l$PROJECT_ALIAS, k$PROJECT_ALIAS, tm$PROJECT_ALIAS, b$PROJECT_ALIAS, pm$PROJECT_ALIAS, $PROJECT_ALIAS"
else
    echo "Project:  (none)"
    echo "Aliases:  l$PROJECT_ALIAS, k$PROJECT_ALIAS, tm$PROJECT_ALIAS, b$PROJECT_ALIAS, pm$PROJECT_ALIAS"
fi
echo ""
read -p "Create? [Y/n]: " CONFIRM
if [[ "$CONFIRM" =~ ^[Nn] ]]; then
    echo "Cancelled."
    exit 0
fi

# 9. Run Ansible
echo ""
echo "Creating project..."

# Build ansible command
ANSIBLE_CMD="ANSIBLE_CONFIG=$OMARCHY_DIR/ansible/ansible.cfg ansible-playbook \
    \"$OMARCHY_DIR/ansible/playbook.yml\" \
    --limit \"$(cat ~/.machine)\" \
    --tags new-project \
    -e \"project_name=$PM_NAME\" \
    -e \"project_alias=$PROJECT_ALIAS\" \
    -e \"project_type=$PROJECT_TYPE\" \
    -e \"project_editor=$PROJECT_EDITOR\" \
    -e \"docker_compose=$DOCKER_COMPOSE\" \
    -e \"default_ws=$DEFAULT_WS\""

if [ -n "$PROJECT_PATH" ]; then
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"project_path=$PROJECT_PATH\""
else
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"project_path=\""
fi

if [ -n "$GITHUB_REPO" ]; then
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"github_repo=$GITHUB_REPO\""
fi

if [ -n "$CREATE_EMPTY_DIR" ]; then
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"create_project_dir=$CREATE_EMPTY_DIR\""
fi

if [ -n "$VIEW_URL" ]; then
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"view_url=$VIEW_URL\""
fi

# Pass port assignments for Laravel projects
if [ "$PROJECT_TYPE" = "laravel" ] && [ "$DOCKER_COMPOSE" = true ]; then
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"vite_port=$PORT_VITE\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"nginx_port=$PORT_NGINX\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"postgres_port=$PORT_POSTGRES\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"redis_port=$PORT_REDIS\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"meilisearch_port=$PORT_MEILISEARCH\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"minio_api_port=$PORT_MINIO_API\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"minio_console_port=$PORT_MINIO_CONSOLE\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"mailpit_smtp_port=$PORT_MAILPIT_SMTP\""
    ANSIBLE_CMD="$ANSIBLE_CMD -e \"mailpit_web_port=$PORT_MAILPIT_WEB\""
fi

eval $ANSIBLE_CMD

# 10. Success message
echo ""
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë  Project '$DISPLAY_NAME' created!                            "
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "üìÅ DIRECTORIES"
echo "   Project Management: ~/Omarchy/projects/$PM_NAME"
if [ -n "$PROJECT_PATH" ]; then
    if [ -n "$GITHUB_REPO" ]; then
        echo "   Project Code:       $PROJECT_PATH (cloned from github.com/$GITHUB_REPO)"
    elif [ -n "$CREATE_EMPTY_DIR" ]; then
        echo "   Project Code:       $PROJECT_PATH (created)"
    else
        echo "   Project Code:       $PROJECT_PATH"
    fi
fi
echo ""
echo "ALIASES (available after: source ~/.aliases)"
echo "   l$PROJECT_ALIAS   ‚Üí  Launch project ($PROJECT_EDITOR, docker, etc.)"
echo "   k$PROJECT_ALIAS   ‚Üí  Kill project (stop docker, close windows)"
echo "   tm$PROJECT_ALIAS  ‚Üí  Launch tmux session"
echo "   b$PROJECT_ALIAS   ‚Üí  Bootstrap project (clone, secrets, build)"
echo "   pm$PROJECT_ALIAS  ‚Üí  cd to project management dir"
if [ -n "$PROJECT_PATH" ]; then
    echo "   $PROJECT_ALIAS    ‚Üí  cd to project code"
    echo "   vs$PROJECT_ALIAS  ‚Üí  Open VS Code to workspace"
    echo "   nv$PROJECT_ALIAS  ‚Üí  Open NeoVim in project dir"
    echo "   p$PROJECT_ALIAS   ‚Üí  Open Positron to workspace"
fi
if [ "$DOCKER_COMPOSE" = true ]; then
    echo "   d$PROJECT_ALIAS   ‚Üí  Docker compose up"
    echo "   dd$PROJECT_ALIAS  ‚Üí  Docker compose down"
fi
echo ""
echo "FILES CREATED"
echo "   ~/Omarchy/projects/$PM_NAME/launch    (project launcher)"
echo "   ~/Omarchy/projects/$PM_NAME/kill      (project killer)"
echo "   ~/Omarchy/projects/$PM_NAME/bootstrap (clone, deps, secrets)"
echo "   ~/Omarchy/projects/$PM_NAME/tmux.sh   (tmux session)"
if [ "$PROJECT_EDITOR" = "vscode" ] || [ "$PROJECT_EDITOR" = "positron" ]; then
    echo "   ~/Omarchy/projects/$PM_NAME/$KEBAB_NAME.code-workspace"
fi
echo "   ~/.aliases                           (updated)"
echo ""

# 11. Reload aliases and cd to project management dir
echo "Reloading aliases and changing to ~/Omarchy/projects/$PM_NAME..."
source ~/.aliases
cd "$HOME/Omarchy/projects/$PM_NAME" && exec $SHELL
