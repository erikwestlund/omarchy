#!/bin/bash
# fix-resume-status - Show system state for diagnosing post-resume stutter
#
# Run this when experiencing lag to capture diagnostic info.

echo "=== Post-Resume Diagnostic Status ==="
echo "Timestamp: $(date)"
echo

echo "--- Load & CPU ---"
uptime
echo

echo "--- CPU Frequency Scaling ---"
echo "Driver: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver)"
echo "Governor: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"
if [[ -f /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference ]]; then
    echo "EPP: $(cat /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference)"
fi
echo

echo "--- Current CPU Frequencies (MHz) ---"
paste <(cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq) | awk '{for(i=1;i<=NF;i++) printf "%d ", $i/1000; print ""}'
echo

echo "--- Power Profile ---"
if command -v powerprofilesctl &> /dev/null; then
    echo "Profile: $(powerprofilesctl get)"
else
    echo "power-profiles-daemon not available"
fi
echo

echo "--- GPU Status ---"
echo "GPU: $(lspci | grep -i display)"
echo

echo "--- Recent suspend/resume (last 5) ---"
sudo dmesg | grep -iE "(suspend entry|suspend exit)" | tail -5
echo

echo "--- Recent GPU errors ---"
if sudo dmesg | grep -iE "(dmcub|amdgpu.*error|amdgpu.*fail|amdgpu.*timeout)" | tail -5 | grep -q .; then
    sudo dmesg | grep -iE "(dmcub|amdgpu.*error|amdgpu.*fail|amdgpu.*timeout)" | tail -5
else
    echo "(none found)"
fi
echo

echo "=== Recommended Actions ==="
echo "1. Run 'fix-resume-gpu' to try GPU recovery"
echo "2. Run 'fix-resume-cpu' to try CPU frequency reset"
echo "3. Note which one fixes the issue for permanent solution"
