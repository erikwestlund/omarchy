#!/bin/bash
# fix-resume-cpu - Try CPU frequency fix for post-resume stutter
#
# Use this when experiencing lag/stutter after resume from sleep.
# If this fixes the issue, the root cause is amd-pstate-epp resuming
# in a broken state (cores stuck in aggressive power saving).
#
# This script resets EPP to balanced and optionally forces performance mode.

set -e

echo "=== CPU Frequency Fix ==="
echo

# Show current state
echo "Current scaling driver: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver)"
echo "Current governor: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)"
if [[ -f /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference ]]; then
    echo "Current EPP: $(cat /sys/devices/system/cpu/cpu0/cpufreq/energy_performance_preference)"
fi
echo

# Check if power-profiles-daemon is running
if systemctl is-active --quiet power-profiles-daemon; then
    echo "power-profiles-daemon is active. Using powerprofilesctl..."
    echo "Current profile: $(powerprofilesctl get)"
    echo
    echo "Setting to performance mode..."
    powerprofilesctl set performance
    sleep 1
    echo "Setting back to balanced..."
    powerprofilesctl set balanced
    echo "Current profile: $(powerprofilesctl get)"
else
    echo "Resetting EPP to balance_performance..."
    echo balance_performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference > /dev/null
fi

echo
echo "CPU frequency settings reset. If stutter is gone, the issue is CPU pstate-related."
echo "Permanent fix: add 'amd_pstate=active' to kernel cmdline (disables EPP)."
