#!/bin/bash
# Project management script - clone repos and scaffold tmux sessions

set -e

PROJECTS_DIR="${PROJECTS_DIR:-$HOME/Projects}"
TMUX_SCRIPTS_DIR="$HOME/.config/projects/tmux"
ALIASES_FILE="$HOME/.config/projects/aliases"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: proj <command> [options]"
    echo ""
    echo "Commands:"
    echo "  add <repo-url> [name]    Clone repo and create tmux session script"
    echo "  init <name> [path]       Create tmux session script for existing project"
    echo "  list                     List all projects with tmux sessions"
    echo "  edit <name>              Edit a project's tmux start script"
    echo "  rm <name>                Remove a project's tmux script and aliases"
    echo "  aliases                  Regenerate all project aliases"
    echo ""
    echo "Examples:"
    echo "  proj add git@github.com:user/myapp.git"
    echo "  proj add git@github.com:user/myapp.git myapp"
    echo "  proj init pequod ~/Projects/pequod"
    echo ""
    echo "Environment:"
    echo "  PROJECTS_DIR    Base directory for projects (default: ~/Projects)"
}

# Extract project name from git URL
extract_name() {
    local url="$1"
    local name="${url##*/}"      # Remove path
    name="${name%.git}"          # Remove .git suffix
    name="${name//./-}"          # Replace dots with dashes
    echo "$name"
}

# Create short alias from name (e.g., pequod-page -> peqp, better-shoes -> bs)
create_short_alias() {
    local name="$1"
    # Split by - or _ and take first letters, max 4 chars
    echo "$name" | sed 's/[-_]/ /g' | awk '{
        result = ""
        for (i = 1; i <= NF && length(result) < 4; i++) {
            if (length($i) > 0) {
                result = result substr($i, 1, 1)
            }
        }
        # If single word, take first 3-4 chars
        if (NF == 1) {
            result = substr($1, 1, 3)
        }
        print result
    }'
}

# Ensure directories exist
ensure_dirs() {
    mkdir -p "$PROJECTS_DIR"
    mkdir -p "$TMUX_SCRIPTS_DIR"
    mkdir -p "$(dirname "$ALIASES_FILE")"
}

# Generate tmux start script from template
generate_tmux_script() {
    local name="$1"
    local project_path="$2"
    local script_path="$TMUX_SCRIPTS_DIR/start_${name}.sh"

    # Convert dashes to underscores for session name
    local session_name="${name//-/_}"

    cat > "$script_path" << EOF
#!/bin/bash
# Start $name development tmux session

SESSION_NAME="$session_name"
PROJECT_DIR="$project_path"

# Check if session already exists
tmux has-session -t \$SESSION_NAME 2>/dev/null

if [ \$? != 0 ]; then
    # Create new session with bash window (index 0)
    tmux new-session -d -s \$SESSION_NAME -n "bash" -c "\$PROJECT_DIR" /bin/bash

    # Create Claude window (index 1)
    tmux new-window -t \$SESSION_NAME:1 -n "claude" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:1 "claude" C-m

    # Create Codex windows for different models (indexes 2-5)
    tmux new-window -t \$SESSION_NAME:2 -n "co-mini" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:2 "codex --full-auto --model gpt-5.1-codex-mini -c model_reasoning_effort=\"low\"" C-m

    tmux new-window -t \$SESSION_NAME:3 -n "co-m" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:3 "codex --full-auto --model gpt-5.1-codex -c model_reasoning_effort=\"medium\"" C-m

    tmux new-window -t \$SESSION_NAME:4 -n "co-max" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:4 "codex --full-auto --model gpt-5.1-codex-max -c model_reasoning_effort=\"high\"" C-m

    tmux new-window -t \$SESSION_NAME:5 -n "co-gpt" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:5 "codex --full-auto --model gpt-5.1 -c model_reasoning_effort=\"high\"" C-m

    # Create Zai window (index 6)
    tmux new-window -t \$SESSION_NAME:6 -n "zai" -c "\$PROJECT_DIR" /bin/bash
    tmux send-keys -t \$SESSION_NAME:6 "zai" C-m

    # Go back to bash window (index 0)
    tmux select-window -t \$SESSION_NAME:0
fi

# Attach to session
tmux attach-session -t \$SESSION_NAME
EOF

    chmod +x "$script_path"
    echo -e "${GREEN}Created:${NC} $script_path"
}

# Regenerate aliases file
regenerate_aliases() {
    local aliases_content="# Project tmux session aliases (auto-generated by proj)\n"
    aliases_content+="# Source this file in your shell config\n\n"

    for script in "$TMUX_SCRIPTS_DIR"/start_*.sh; do
        [ -f "$script" ] || continue

        local basename=$(basename "$script")
        local name="${basename#start_}"
        name="${name%.sh}"
        local short=$(create_short_alias "$name")

        # Full aliases: tm_name and tmname
        aliases_content+="alias tm_${name}=\"$script\"\n"
        aliases_content+="alias tm${name}=\"$script\"\n"
        # Short alias: tm + short (e.g., tmpeq)
        aliases_content+="alias tm${short}=\"$script\"\n"
        aliases_content+="\n"
    done

    echo -e "$aliases_content" > "$ALIASES_FILE"
    echo -e "${GREEN}Updated:${NC} $ALIASES_FILE"
}

# Clone a repo and set up tmux session
cmd_add() {
    local repo_url="$1"
    local name="${2:-$(extract_name "$repo_url")}"

    if [ -z "$repo_url" ]; then
        echo -e "${RED}Error:${NC} Repository URL required"
        usage
        exit 1
    fi

    ensure_dirs

    local project_path="$PROJECTS_DIR/$name"

    if [ -d "$project_path" ]; then
        echo -e "${YELLOW}Warning:${NC} Project directory already exists: $project_path"
        echo "Creating tmux script anyway..."
    else
        echo -e "${BLUE}Cloning:${NC} $repo_url -> $project_path"
        git clone "$repo_url" "$project_path"
    fi

    generate_tmux_script "$name" "$project_path"
    regenerate_aliases

    echo ""
    echo -e "${GREEN}Done!${NC} Start the session with: tm${name} or tm_${name} or tm$(create_short_alias "$name")"
    echo "Reload your shell or run: source $ALIASES_FILE"
}

# Initialize tmux session for existing project
cmd_init() {
    local name="$1"
    local project_path="${2:-$PROJECTS_DIR/$name}"

    if [ -z "$name" ]; then
        echo -e "${RED}Error:${NC} Project name required"
        usage
        exit 1
    fi

    # Expand ~ if present
    project_path="${project_path/#\~/$HOME}"

    if [ ! -d "$project_path" ]; then
        echo -e "${RED}Error:${NC} Directory does not exist: $project_path"
        exit 1
    fi

    ensure_dirs
    generate_tmux_script "$name" "$project_path"
    regenerate_aliases

    echo ""
    echo -e "${GREEN}Done!${NC} Start the session with: tm${name} or tm_${name} or tm$(create_short_alias "$name")"
    echo "Reload your shell or run: source $ALIASES_FILE"
}

# List all projects
cmd_list() {
    echo "Projects with tmux sessions:"
    echo ""

    if [ ! -d "$TMUX_SCRIPTS_DIR" ] || [ -z "$(ls -A "$TMUX_SCRIPTS_DIR" 2>/dev/null)" ]; then
        echo "  (none)"
        return
    fi

    for script in "$TMUX_SCRIPTS_DIR"/start_*.sh; do
        [ -f "$script" ] || continue

        local basename=$(basename "$script")
        local name="${basename#start_}"
        name="${name%.sh}"
        local short=$(create_short_alias "$name")

        # Extract project path from script
        local path=$(grep "^PROJECT_DIR=" "$script" | cut -d'"' -f2)

        printf "  ${GREEN}%-20s${NC} tm%-12s tm_%-12s tm%-6s\n" "$name" "$name" "$name" "$short"
        echo "                       $path"
        echo ""
    done
}

# Edit a project's tmux script
cmd_edit() {
    local name="$1"
    local script_path="$TMUX_SCRIPTS_DIR/start_${name}.sh"

    if [ -z "$name" ]; then
        echo -e "${RED}Error:${NC} Project name required"
        exit 1
    fi

    if [ ! -f "$script_path" ]; then
        echo -e "${RED}Error:${NC} No tmux script found for: $name"
        exit 1
    fi

    ${EDITOR:-nvim} "$script_path"
}

# Remove a project's tmux script
cmd_rm() {
    local name="$1"
    local script_path="$TMUX_SCRIPTS_DIR/start_${name}.sh"

    if [ -z "$name" ]; then
        echo -e "${RED}Error:${NC} Project name required"
        exit 1
    fi

    if [ ! -f "$script_path" ]; then
        echo -e "${RED}Error:${NC} No tmux script found for: $name"
        exit 1
    fi

    rm "$script_path"
    echo -e "${GREEN}Removed:${NC} $script_path"

    regenerate_aliases
}

# Main
case "${1:-}" in
    add)
        cmd_add "$2" "$3"
        ;;
    init)
        cmd_init "$2" "$3"
        ;;
    list|ls)
        cmd_list
        ;;
    edit)
        cmd_edit "$2"
        ;;
    rm|remove)
        cmd_rm "$2"
        ;;
    aliases)
        ensure_dirs
        regenerate_aliases
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command: $1"
        usage
        exit 1
        ;;
esac
