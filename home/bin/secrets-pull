#!/bin/bash
# Pull and decrypt secrets from B2
set -e

CONFIG="$HOME/.config/secrets/config"
SECRETS_DIR="$HOME/.secrets"
VAULT_FILE="$HOME/Omarchy/ansible/vault/secrets.yml"
CACHE_DIR="$HOME/.cache/secrets-encrypted"
PROJECTS_DIR="$HOME/Projects"
ENV_CACHE_DIR="$HOME/.cache/secrets-env-encrypted"

if [[ ! -f "$CONFIG" ]]; then
    echo "Error: Config not found at $CONFIG"
    echo "Run 'ansible-playbook playbook.yml --tags secrets' first to deploy credentials"
    exit 1
fi

source "$CONFIG"

# Validate config
if [[ -z "$B2_KEY_ID" || -z "$B2_APP_KEY" || -z "$B2_BUCKET" || -z "$AGE_SECRET_KEY" ]]; then
    echo "Error: Missing required config variables"
    exit 1
fi

echo "Syncing encrypted secrets from B2..."
mkdir -p "$CACHE_DIR"

# Configure rclone on the fly
export RCLONE_CONFIG_B2_TYPE=b2
export RCLONE_CONFIG_B2_ACCOUNT="$B2_KEY_ID"
export RCLONE_CONFIG_B2_KEY="$B2_APP_KEY"

# Sync from B2 to cache (only if remote is newer)
rclone sync "b2:$B2_BUCKET/secrets/" "$CACHE_DIR/" --update --progress

echo "Decrypting secrets..."
mkdir -p "$SECRETS_DIR"
chmod 700 "$SECRETS_DIR"

# Write age key to temp file for decryption
AGE_KEY_FILE=$(mktemp)
echo "$AGE_SECRET_KEY" > "$AGE_KEY_FILE"
chmod 600 "$AGE_KEY_FILE"
trap "rm -f $AGE_KEY_FILE" EXIT

# Decrypt all .age files, preserving directory structure
find "$CACHE_DIR" -name "*.age" | while read -r encrypted_file; do
    # Get relative path and remove .age extension
    rel_path="${encrypted_file#$CACHE_DIR/}"
    output_path="$SECRETS_DIR/${rel_path%.age}"

    # Create parent directory
    mkdir -p "$(dirname "$output_path")"

    # Decrypt
    age -d -i "$AGE_KEY_FILE" "$encrypted_file" > "$output_path"
    chmod 600 "$output_path"
    echo "  Decrypted: ${rel_path%.age}"
done

# Decrypt ansible vault file if it exists in cache
if [[ -f "$CACHE_DIR/ansible-vault.yml.age" ]]; then
    mkdir -p "$(dirname "$VAULT_FILE")"
    age -d -i "$AGE_KEY_FILE" "$CACHE_DIR/ansible-vault.yml.age" > "$VAULT_FILE"
    chmod 600 "$VAULT_FILE"
    echo "  Decrypted: ansible-vault.yml -> $VAULT_FILE"
fi

# Sync .env files from B2 (only if remote is newer)
echo "Syncing .env files from B2 (only if newer)..."
mkdir -p "$ENV_CACHE_DIR"
rclone copy "b2:$B2_BUCKET/projects-env/" "$ENV_CACHE_DIR/" --update --progress

# Decrypt .env files to Projects directory
if [[ -d "$ENV_CACHE_DIR" ]] && [[ -n "$(ls -A "$ENV_CACHE_DIR" 2>/dev/null)" ]]; then
    echo "Decrypting .env files..."
    find "$ENV_CACHE_DIR" -name "*.age" -type f 2>/dev/null | while read -r encrypted_file; do
        rel_path="${encrypted_file#$ENV_CACHE_DIR/}"
        output_path="$PROJECTS_DIR/${rel_path%.age}"

        # Only decrypt if remote is newer than local (or local doesn't exist)
        if [[ ! -f "$output_path" ]] || [[ "$encrypted_file" -nt "$output_path" ]]; then
            mkdir -p "$(dirname "$output_path")"
            age -d -i "$AGE_KEY_FILE" "$encrypted_file" > "$output_path"
            chmod 600 "$output_path"
            echo "  Decrypted: ${rel_path%.age}"
        else
            echo "  Skipped (local newer): ${rel_path%.age}"
        fi
    done
fi

echo "Done. Secrets available at $SECRETS_DIR"
