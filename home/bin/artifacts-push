#!/bin/bash
# Push project artifacts to NAS
# Usage: artifacts-push [project]  - push one project
#        artifacts-push            - push all projects with artifacts
set -e

PROJECTS_DIR="$HOME/Projects"
NAS_DIR="/mnt/nas/WorkArtifacts"

# Default patterns for framework projects (auto-detected via framework.db)
FRAMEWORK_PATTERNS=(
    "inputs/"
    "outputs/"
    "framework.db"
)

push_project() {
    local PROJECT="$1"
    local PROJECT_DIR="$PROJECTS_DIR/$PROJECT"

    if [[ ! -d "$PROJECT_DIR" ]]; then
        echo "Error: Project directory not found: $PROJECT_DIR"
        return 1
    fi

    echo "=== $PROJECT ==="
    echo "Source: $PROJECT_DIR"
    echo "Destination: $NAS_DIR/$PROJECT/"

    # Build rsync include/exclude list
    local RSYNC_ARGS=()
    local ARTIFACTS_FILE="$PROJECT_DIR/.artifacts"

    # Check for .artifacts file first
    if [[ -f "$ARTIFACTS_FILE" ]] && [[ -s "$ARTIFACTS_FILE" ]]; then
        echo "Using patterns from .artifacts"
        while IFS= read -r pattern || [[ -n "$pattern" ]]; do
            # Skip empty lines and comments
            [[ -z "$pattern" || "$pattern" == \#* ]] && continue
            RSYNC_ARGS+=(--include="$pattern" --include="$pattern**")
        done < "$ARTIFACTS_FILE"
    # Auto-detect framework projects via framework.db
    elif [[ -f "$PROJECT_DIR/framework.db" ]]; then
        echo "Detected framework project (framework.db found)"
        for pattern in "${FRAMEWORK_PATTERNS[@]}"; do
            RSYNC_ARGS+=(--include="$pattern" --include="$pattern**")
        done
    else
        echo "No .artifacts file and no framework.db - skipping"
        echo ""
        return 0
    fi

    # Exclude everything else
    RSYNC_ARGS+=(--exclude="*")

    # Create project directory on NAS if needed
    mkdir -p "$NAS_DIR/$PROJECT"

    rsync -av --update --progress "${RSYNC_ARGS[@]}" "$PROJECT_DIR/" "$NAS_DIR/$PROJECT/"
    echo ""
}

has_artifacts() {
    local PROJECT_DIR="$1"
    # Has .artifacts file with content, or has framework.db
    [[ -f "$PROJECT_DIR/.artifacts" && -s "$PROJECT_DIR/.artifacts" ]] || [[ -f "$PROJECT_DIR/framework.db" ]]
}

# Trigger autofs mount
ls "$NAS_DIR" > /dev/null 2>&1 || true

if [[ -n "$1" ]]; then
    # Single project specified
    push_project "$1"
elif [[ "$(pwd)" == "$PROJECTS_DIR/"* ]]; then
    # In a project directory, push that project
    REL_PATH="${PWD#$PROJECTS_DIR/}"
    PROJECT="${REL_PATH%%/*}"
    push_project "$PROJECT"
else
    # No argument and not in project dir: push all projects with artifacts
    echo "Pushing all projects with artifacts..."
    echo ""

    FOUND=0
    for PROJECT_DIR in "$PROJECTS_DIR"/*/; do
        [[ -d "$PROJECT_DIR" ]] || continue
        PROJECT="$(basename "$PROJECT_DIR")"
        if has_artifacts "$PROJECT_DIR"; then
            push_project "$PROJECT"
            FOUND=$((FOUND + 1))
        fi
    done

    if [[ $FOUND -eq 0 ]]; then
        echo "No projects found with artifacts"
        exit 1
    fi

    echo "Done. Pushed $FOUND project(s)."
fi
