---
# Omarchy Ansible Playbook
# Usage:
#   ansible-playbook ansible/playbook.yml --ask-vault-pass
#   ansible-playbook ansible/playbook.yml --ask-vault-pass --tags packages
#   ansible-playbook ansible/playbook.yml --ask-vault-pass --limit laptop

- name: Configure Omarchy
  hosts: all
  connection: local
  gather_facts: true

  vars_files:
    - vault/secrets.yml

  pre_tasks:
    - name: Check for uncommitted changes in Omarchy repo
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: "{{ omarchy_repo }}"
      register: git_status
      changed_when: false
      tags: always

    - name: Warn about uncommitted changes
      ansible.builtin.debug:
        msg: "WARNING: Uncommitted changes in {{ omarchy_repo }}. Skipping git pull. Commit or stash changes to enable auto-pull."
      when: git_status.stdout | length > 0
      tags: always

    - name: Pull latest Omarchy repo
      ansible.builtin.git:
        repo: "{{ omarchy_repo_url | default('git@github.com:erikwestlund/omarchy.git') }}"
        dest: "{{ omarchy_repo }}"
        update: true
        version: main
      tags: always
      register: repo_pull
      changed_when: repo_pull.changed
      when: git_status.stdout | length == 0
      ignore_errors: true

    - name: Detect Framework laptop
      ansible.builtin.set_fact:
        is_framework: "{{ ansible_facts['board_vendor'] | default('') == 'Framework' }}"
      tags: always

  roles:
    - role: packages
      tags: packages

    - role: dotfiles
      tags: dotfiles

    - role: snapper
      tags: snapper

    - role: vscode
      tags: vscode

    - role: keyd
      tags: keyd
      when: keyboards | default([]) | length > 0

    - role: framework
      tags: framework
      when: is_framework | default(false)

    - role: secrets
      tags: secrets

    - role: webapps
      tags: webapps

    - role: nas
      tags: nas

    - role: syncthing
      tags: syncthing

    - role: sshd
      tags: sshd

    - role: chromium
      tags: chromium

    - role: dnsmasq
      tags: dnsmasq

    - role: caddy
      tags: caddy

    - role: pulsesecure
      tags: pulsesecure

    - role: vms
      tags: vms
      when: vms | default([]) | length > 0

    - role: remmina
      tags: remmina

    - role: projects
      tags: new-project
      when: project_name is defined
