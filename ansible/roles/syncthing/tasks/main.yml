---
# Syncthing configuration
# Connects to Syncthing server VM (separate from NAS)

- name: Wait for Syncthing to be ready
  ansible.builtin.command: syncthing cli show system
  register: syncthing_status
  until: syncthing_status.rc == 0
  retries: 10
  delay: 2
  changed_when: false

# Configure GUI for local.syncthing.lan access via Caddy proxy
- name: Allow local.syncthing.lan hostname in GUI
  ansible.builtin.command: syncthing cli config gui insecure-skip-host-check set true
  changed_when: false

- name: Disable TLS for GUI (Caddy handles external access)
  ansible.builtin.command: syncthing cli config gui raw-use-tls set false
  changed_when: false

- name: Check if Syncthing server device exists
  ansible.builtin.command: syncthing cli config devices list
  register: syncthing_devices
  changed_when: false

- name: Add Syncthing server device
  ansible.builtin.command: >
    syncthing cli config devices add
    --device-id {{ syncthing_server_device_id }}
    --name "Syncthing Server"
  when: syncthing_server_device_id not in syncthing_devices.stdout

- name: Get current server addresses
  ansible.builtin.command: syncthing cli config devices {{ syncthing_server_device_id }} dump-json
  register: server_device_config
  changed_when: false
  when: syncthing_server_device_id in syncthing_devices.stdout or syncthing_devices.changed is defined

- name: Add LAN address if missing
  ansible.builtin.command: >
    syncthing cli config devices {{ syncthing_server_device_id }} addresses add "{{ syncthing_server_lan_address }}"
  when: >
    server_device_config.stdout is defined and
    syncthing_server_lan_address not in server_device_config.stdout

- name: Add DDNS address if missing
  ansible.builtin.command: >
    syncthing cli config devices {{ syncthing_server_device_id }} addresses add "{{ syncthing_server_ddns_address }}"
  when: >
    server_device_config.stdout is defined and
    syncthing_server_ddns_address not in server_device_config.stdout

# Folder configuration
- name: Check existing folders
  ansible.builtin.command: syncthing cli config folders list
  register: syncthing_folders
  changed_when: false

# Ensure all sync directories exist with .stfolder markers
- name: Ensure sync directories exist
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - Documents
    - Work
    - Desktop
    - Screenshots
    - Scans
    - Photos
    - Downloads

- name: Create .stfolder markers for all sync directories
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}/.stfolder"
    state: touch
    mode: '0644'
  loop:
    - Documents
    - Work
    - Desktop
    - Screenshots
    - Scans
    - Photos
    - Downloads
  changed_when: false

- name: Add Documents folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_documents_folder_id }}"
    --label "Documents"
    --path ~/Documents
  when: syncthing_documents_folder_id not in syncthing_folders.stdout

- name: Associate Documents with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_documents_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_documents_folder_id not in syncthing_folders.stdout

- name: Add Work folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_work_folder_id }}"
    --label "Work"
    --path ~/Work
  when: syncthing_work_folder_id not in syncthing_folders.stdout

- name: Associate Work with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_work_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_work_folder_id not in syncthing_folders.stdout

- name: Create .stignore for Work (ignore OneDrive mount)
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/Work/.stignore"
    content: "OneDrive\n"
    mode: '0644'
    force: false

- name: Add Desktop folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_desktop_folder_id }}"
    --label "Desktop"
    --path ~/Desktop
  when: syncthing_desktop_folder_id not in syncthing_folders.stdout

- name: Associate Desktop with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_desktop_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_desktop_folder_id not in syncthing_folders.stdout

- name: Add Screenshots folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_screenshots_folder_id }}"
    --label "Screenshots"
    --path ~/Screenshots
  when: syncthing_screenshots_folder_id not in syncthing_folders.stdout

- name: Associate Screenshots with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_screenshots_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_screenshots_folder_id not in syncthing_folders.stdout

- name: Add Scans folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_scans_folder_id }}"
    --label "Scans"
    --path ~/Scans
  when: syncthing_scans_folder_id not in syncthing_folders.stdout

- name: Associate Scans with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_scans_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_scans_folder_id not in syncthing_folders.stdout

# Chromium bookmarks sync (just bookmarks, not full profile)
- name: Ensure Chromium sync directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.sync/Chromium"
    state: directory
    mode: '0755'

- name: Create Syncthing folder marker for Chromium
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.sync/Chromium/.stfolder"
    state: touch
    mode: '0644'
  changed_when: false

- name: Add Chromium folder to Syncthing
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_chromium_folder_id }}"
    --label "Chromium Bookmarks"
    --path ~/.sync/Chromium
  when: syncthing_chromium_folder_id not in syncthing_folders.stdout

- name: Associate Chromium with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_chromium_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_chromium_folder_id not in syncthing_folders.stdout

- name: Ensure Chromium folder path is correct
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_chromium_folder_id }} path set ~/.sync/Chromium
  when: syncthing_chromium_folder_id in syncthing_folders.stdout
  changed_when: false

- name: Ensure Chromium Default directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/chromium/Default"
    state: directory
    mode: '0755'

- name: Check if Bookmarks is already a symlink
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/chromium/Default/Bookmarks"
  register: bookmarks_stat

- name: Backup existing Bookmarks file if not a symlink
  ansible.builtin.copy:
    src: "{{ ansible_facts.env.HOME }}/.config/chromium/Default/Bookmarks"
    dest: "{{ ansible_facts.env.HOME }}/.config/chromium/Default/Bookmarks.pre-sync-backup"
    remote_src: true
    mode: '0600'
  when: bookmarks_stat.stat.exists and not bookmarks_stat.stat.islnk

- name: Remove existing Bookmarks file if not a symlink
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/chromium/Default/Bookmarks"
    state: absent
  when: bookmarks_stat.stat.exists and not bookmarks_stat.stat.islnk

- name: Create Bookmarks symlink to Sync folder
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.sync/Chromium/Bookmarks"
    dest: "{{ ansible_facts.env.HOME }}/.config/chromium/Default/Bookmarks"
    state: link
    force: true
    follow: false

# Photos sync
- name: Add Photos folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_photos_folder_id }}"
    --label "Photos"
    --path ~/Photos
  when: syncthing_photos_folder_id not in syncthing_folders.stdout

- name: Associate Photos with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_photos_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_photos_folder_id not in syncthing_folders.stdout

# Downloads sync
- name: Add Downloads folder
  ansible.builtin.command: >
    syncthing cli config folders add
    --id "{{ syncthing_downloads_folder_id }}"
    --label "Downloads"
    --path ~/Downloads
  when: syncthing_downloads_folder_id not in syncthing_folders.stdout

- name: Associate Downloads with server
  ansible.builtin.command: >
    syncthing cli config folders {{ syncthing_downloads_folder_id }} devices add
    --device-id {{ syncthing_server_device_id }}
  when: syncthing_downloads_folder_id not in syncthing_folders.stdout
