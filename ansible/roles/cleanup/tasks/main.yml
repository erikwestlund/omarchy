---
# Remove unwanted applications that come with Omarchy base

# =====================================================
# Hibernate cleanup - remove all hibernation artifacts
# =====================================================

- name: Remove hibernate limine config
  become: true
  ansible.builtin.file:
    path: /etc/limine-entry-tool.d/50-hibernate.conf
    state: absent
  register: hibernate_limine_removed
  notify: Regenerate limine

- name: Remove hibernate logind config
  become: true
  ansible.builtin.file:
    path: /etc/systemd/logind.conf.d/lid.conf
    state: absent
  notify: Restart logind

- name: Remove resume hook from mkinitcpio HOOKS
  become: true
  ansible.builtin.lineinfile:
    path: /etc/mkinitcpio.conf
    regexp: '^HOOKS=\(.*resume.*\)$'
    line: 'HOOKS=(base udev autodetect microcode modconf kms keyboard keymap consolefont block encrypt filesystems fsck)'
    backup: true
  register: mkinitcpio_changed
  notify: Regenerate initramfs

# =====================================================
# Application cleanup
# =====================================================

# Remove native Zoom artifacts (reverted to webapp)
- name: Remove Zoom desktop file override
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications/Zoom.desktop"
    state: absent

# Remove unwanted packages
- name: Remove unwanted pacman packages
  become: true
  community.general.pacman:
    name: "{{ cleanup_pacman_packages }}"
    state: absent
  when: cleanup_pacman_packages | default([]) | length > 0

- name: Remove unwanted AUR packages
  become: true
  community.general.pacman:
    name: "{{ cleanup_aur_packages }}"
    state: absent
  when: cleanup_aur_packages | default([]) | length > 0

# Remove unwanted webapp desktop files (user-created)
- name: Remove unwanted webapp desktop files
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications/{{ item }}"
    state: absent
  loop: "{{ cleanup_webapps }}"
  when:
    - cleanup_webapps | default([]) | length > 0
    - item is not match('^[a-z]')  # Skip lowercase names (system files)

# Hide system desktop files by creating override stubs
- name: Hide system desktop files
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.local/share/applications/{{ item }}"
    content: |
      [Desktop Entry]
      Type=Application
      Hidden=true
      NoDisplay=true
    mode: "0644"
  loop: "{{ cleanup_webapps }}"
  when:
    - cleanup_webapps | default([]) | length > 0
    - item is match('^[a-z]')  # Only lowercase names (system files like xdvi.desktop)

