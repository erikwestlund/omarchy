---
# Create a single VM

- name: "Check if VM {{ vm.name }} exists"
  become: true
  ansible.builtin.command: "virsh dominfo {{ vm.name }}"
  register: vm_exists
  failed_when: false
  changed_when: false

- name: "Check if ISO exists for {{ vm.name }}"
  ansible.builtin.stat:
    path: "{{ vm.iso }}"
  register: iso_stat
  when: vm_exists.rc != 0

- name: "Fail if ISO missing for {{ vm.name }}"
  ansible.builtin.fail:
    msg: "ISO not found: {{ vm.iso }}"
  when: vm_exists.rc != 0 and not iso_stat.stat.exists

- name: "Create VM {{ vm.name }}"
  become: true
  ansible.builtin.command: >
    virt-install
    --name {{ vm.name }}
    --ram {{ vm.ram_mb }}
    --vcpus {{ vm.vcpus }}
    --os-variant {{ vm.os_variant }}
    --disk path={{ vm_disk_path }}/{{ vm.name }}.qcow2,size={{ vm.disk_size_gb }},format=qcow2,bus=virtio
    --cdrom {{ vm.iso }}
    {% if vm.virtio_iso is defined %}
    --disk path={{ vm.virtio_iso }},device=cdrom
    {% endif %}
    --network network=default,model=virtio
    --graphics spice,listen=socket
    --video qxl
    --channel spicevmc,target.type=virtio,target.name=com.redhat.spice.0
    --boot uefi
    {% if vm.tpm | default(true) %}
    --tpm backend.type=emulator,backend.version=2.0,model=tpm-tis
    {% endif %}
    --cpu host-passthrough
    --noautoconsole
  when: vm_exists.rc != 0
  register: vm_created

- name: "VM {{ vm.name }} creation result"
  ansible.builtin.debug:
    msg: "VM {{ vm.name }} created successfully. Use 'virt-manager' or 'virt-viewer {{ vm.name }}' to connect."
  when: vm_created.changed | default(false)

- name: Ensure applications directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications"
    state: directory
    mode: '0755'
  when: vm.create_desktop_entry | default(true)

- name: "Create desktop entry for {{ vm.name }}"
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.local/share/applications/{{ vm.desktop_filename | default(vm.name + '-vm') }}.desktop"
    mode: '0644'
    content: |
      [Desktop Entry]
      Name={{ vm.desktop_name | default(vm.name | capitalize) }}
      Comment={{ vm.name | capitalize }} Virtual Machine
      Exec={{ vm.exec | default('virt-viewer --attach -c qemu:///system ' + vm.name) }}
      Icon={{ vm.icon | default('computer') }}
      Terminal=false
      Type=Application
      Categories=System;Emulator;
      Keywords=vm;virtual;machine;{{ vm.keywords | default('') }}
  when: vm.create_desktop_entry | default(true)
