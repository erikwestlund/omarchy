---
# AMD GPU driver installation
# Only installs if AMD GPU is detected

- name: Check for AMD GPU
  ansible.builtin.shell: |
    lspci | grep -iE 'VGA.*AMD|Display.*AMD|3D.*AMD'
  register: amd_gpu_check
  changed_when: false
  failed_when: false

- name: Install AMD GPU Vulkan packages
  become: true
  community.general.pacman:
    name:
      - vulkan-radeon
      - lib32-vulkan-radeon
    state: present
  when: amd_gpu_check.rc == 0
  retries: 3
  delay: 5
  register: amd_gpu_result
  until: amd_gpu_result is succeeded

- name: Report AMD GPU status
  ansible.builtin.debug:
    msg: "AMD GPU detected and Vulkan drivers installed"
  when: amd_gpu_check.rc == 0

- name: Report no AMD GPU
  ansible.builtin.debug:
    msg: "No AMD GPU detected, skipping driver installation"
  when: amd_gpu_check.rc != 0

# AMD GPU kernel parameters
# /etc/default/limine overrides drop-in configs, so flags must go there directly.
#
# dcdebugmask=0x810: Disable PSR (0x10) + IPS idle power state (0x800) - prevents black screen on resume
# gpu_recovery=1: Enable automatic GPU reset on hang instead of requiring reboot
# sg_display=0: Disable scatter-gather display - Framework 13 AMD flickering/corruption fix
# cwsr_enable=0: Disable compute wave save/restore - fixes MES crashes/page faults on Strix Point
# See: https://gitlab.freedesktop.org/drm/amd/-/issues/2708
# See: https://gitlab.freedesktop.org/drm/amd/-/issues/4749
- name: Add AMD GPU kernel parameters to limine config
  become: true
  ansible.builtin.lineinfile:
    path: /etc/default/limine
    regexp: '^KERNEL_CMDLINE\[default\]\+=".*amdgpu\.'
    line: 'KERNEL_CMDLINE[default]+=" amdgpu.dcdebugmask=0x810 amdgpu.gpu_recovery=1 amdgpu.sg_display=0 amdgpu.cwsr_enable=0"'
    insertafter: '^KERNEL_CMDLINE\[default\]\+="quiet'
  notify: Regenerate limine
  when: amd_gpu_check.rc == 0

- name: Remove obsolete limine drop-in for amdgpu
  become: true
  ansible.builtin.file:
    path: /etc/limine-entry-tool.d/40-amdgpu.conf
    state: absent
  notify: Regenerate limine
