---
# Create new project management setup
# Called with: ansible-playbook playbook.yml --tags new-project -e "project_name=foo project_alias=f project_type=utility project_path=~/Projects/foo"

- name: Validate project type
  ansible.builtin.fail:
    msg: "Invalid project_type '{{ project_type }}'. Valid types: utility, laravel, python, rstats"
  when: project_type not in ['utility', 'laravel', 'python', 'rstats']

# Clone from GitHub if requested
- name: Clone project from GitHub
  ansible.builtin.git:
    repo: "git@github.com:{{ github_repo }}.git"
    dest: "{{ project_path }}"
    accept_hostkey: true
  when: github_repo is defined and github_repo | length > 0

# Create empty project directory if requested
- name: Create empty project directory
  ansible.builtin.file:
    path: "{{ create_project_dir }}"
    state: directory
    mode: '0755'
  when: create_project_dir is defined and create_project_dir | length > 0

- name: Create projects directory in repo
  ansible.builtin.file:
    path: "{{ omarchy_repo }}/projects/{{ project_name }}"
    state: directory
    mode: '0755'

- name: Generate tmux.sh from template
  ansible.builtin.template:
    src: "tmux-{{ project_type }}.sh.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/tmux.sh"
    mode: '0755'

- name: Generate launch script from template
  ansible.builtin.template:
    src: "launch.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/launch"
    mode: '0755'

- name: Generate kill script from template
  ansible.builtin.template:
    src: "kill.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/kill"
    mode: '0755'

- name: Generate bootstrap script from template
  ansible.builtin.template:
    src: "bootstrap.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/bootstrap"
    mode: '0755'

- name: Convert project name to kebab-case for workspace file
  ansible.builtin.set_fact:
    workspace_filename: "{{ project_name | lower | regex_replace('[^a-z0-9]', '-') | regex_replace('-+', '-') | regex_replace('^-|-$', '') }}"

- name: Generate workspace file for vscode/positron
  ansible.builtin.template:
    src: "workspace.code-workspace.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
    mode: '0644'
  when: project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0

# Laravel-specific: Create docker-compose.yml if it doesn't exist
- name: Check if docker-compose.yml exists in project
  ansible.builtin.stat:
    path: "{{ project_path }}/docker-compose.yml"
  register: docker_compose_stat
  when: project_type == 'laravel' and project_path | length > 0

- name: Generate docker-compose.yml for Laravel project
  ansible.builtin.template:
    src: "laravel-docker-compose.yml.j2"
    dest: "{{ project_path }}/docker-compose.yml"
    mode: '0644'
  when: project_type == 'laravel' and project_path | length > 0 and not docker_compose_stat.stat.exists

# Laravel-specific: Create .env in secrets if it doesn't exist
- name: Ensure secrets directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}"
    state: directory
    mode: '0700'
  when: project_type == 'laravel'

- name: Check if .env exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}/.env"
  register: env_secrets_stat
  when: project_type == 'laravel'

- name: Check if .env exists in project
  ansible.builtin.stat:
    path: "{{ project_path }}/.env"
  register: env_project_stat
  when: project_type == 'laravel' and project_path | length > 0

- name: Generate .env for Laravel project in secrets
  ansible.builtin.template:
    src: "laravel-env.j2"
    dest: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}/.env"
    mode: '0600'
  when: project_type == 'laravel' and not env_secrets_stat.stat.exists and (project_path | length == 0 or not env_project_stat.stat.exists)

# Add project to projects.yml for port tracking and documentation
- name: Convert project path to tilde notation
  ansible.builtin.set_fact:
    project_path_tilde: "{{ project_path | regex_replace('^' + ansible_facts.env.HOME, '~') }}"
  when: project_path is defined and project_path | length > 0

- name: Build base project entry
  ansible.builtin.set_fact:
    project_yml_lines:
      - "  - name: {{ project_name }}"
      - "    alias: {{ project_alias }}"
      - "    type: {{ project_type }}"
      - "    path: {{ project_path_tilde | default('') }}"

- name: Add github_repo if provided
  ansible.builtin.set_fact:
    project_yml_lines: "{{ project_yml_lines + ['    github_repo: ' + github_repo] }}"
  when: github_repo is defined and github_repo | length > 0

- name: Add extras section if needed
  ansible.builtin.set_fact:
    project_yml_lines: "{{ project_yml_lines + ['    extras:'] }}"
  when: (view_url is defined and view_url | length > 0) or (default_ws | default(1) | int != 1)

- name: Add view_url to extras
  ansible.builtin.set_fact:
    project_yml_lines: "{{ project_yml_lines + ['      view_url: ' + view_url] }}"
  when: view_url is defined and view_url | length > 0

- name: Add default_ws to extras
  ansible.builtin.set_fact:
    project_yml_lines: "{{ project_yml_lines + ['      default_ws: ' + (default_ws | string)] }}"
  when: default_ws | default(1) | int != 1

- name: Add ports section for Laravel with Docker
  ansible.builtin.set_fact:
    project_yml_lines: "{{ project_yml_lines + ['    ports:', '      vite: ' + (vite_port | default(5173) | string), '      nginx: ' + (nginx_port | default(8010) | string), '      postgres: ' + (postgres_port | default(5432) | string), '      redis: ' + (redis_port | default(6379) | string), '      minio_api: ' + (minio_api_port | default(9000) | string), '      minio_console: ' + (minio_console_port | default(9001) | string), '      mailpit_smtp: ' + (mailpit_smtp_port | default(1025) | string), '      mailpit_web: ' + (mailpit_web_port | default(8025) | string)] }}"
  when: project_type == 'laravel' and docker_compose | default(false) | bool

- name: Add project to projects.yml
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/config/projects/projects.yml"
    marker: "# {mark} PROJECT {{ project_name }}"
    block: "{{ project_yml_lines | join('\n') }}"
    insertafter: EOF

- name: Add project aliases to .aliases (with project dir, with docker)
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/home/.aliases"
    marker: "# {mark} PROJECT {{ project_name }}"
    insertbefore: "# Auto-generated project aliases"
    block: |
      alias l{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/launch"
      alias k{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/kill"
      alias tm{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/tmux.sh"
      alias b{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/bootstrap"
      alias pm{{ project_alias }}="cd ~/Omarchy/projects/{{ project_name }}"
      alias {{ project_alias }}="cd {{ project_path }}"
      alias vs{{ project_alias }}="code ~/Omarchy/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
      alias nv{{ project_alias }}="(cd {{ project_path }} && nvim .)"
      alias p{{ project_alias }}="/usr/share/positron/bin/positron ~/Omarchy/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
      alias d{{ project_alias }}="(cd {{ project_path }} && docker compose up -d)"
      alias dd{{ project_alias }}="(cd {{ project_path }} && docker compose down)"
  when: project_path | length > 0 and docker_compose | default(false) | bool

- name: Add project aliases to .aliases (with project dir, no docker)
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/home/.aliases"
    marker: "# {mark} PROJECT {{ project_name }}"
    insertbefore: "# Auto-generated project aliases"
    block: |
      alias l{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/launch"
      alias k{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/kill"
      alias tm{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/tmux.sh"
      alias b{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/bootstrap"
      alias pm{{ project_alias }}="cd ~/Omarchy/projects/{{ project_name }}"
      alias {{ project_alias }}="cd {{ project_path }}"
      alias vs{{ project_alias }}="code ~/Omarchy/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
      alias nv{{ project_alias }}="(cd {{ project_path }} && nvim .)"
      alias p{{ project_alias }}="/usr/share/positron/bin/positron ~/Omarchy/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
  when: project_path | length > 0 and not (docker_compose | default(false) | bool)

- name: Add project aliases to .aliases (no project dir)
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/home/.aliases"
    marker: "# {mark} PROJECT {{ project_name }}"
    insertbefore: "# Auto-generated project aliases"
    block: |
      alias l{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/launch"
      alias k{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/kill"
      alias tm{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/tmux.sh"
      alias b{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/bootstrap"
      alias pm{{ project_alias }}="cd ~/Omarchy/projects/{{ project_name }}"
  when: project_path | length == 0

- name: Show completion message (Laravel)
  ansible.builtin.debug:
    msg: |
      Project '{{ project_name }}' created!

      Aliases (reload shell to use):
        l{{ project_alias }}   - Launch project (VS Code, docker, etc.)
        k{{ project_alias }}   - Kill project (stop docker, close windows)
        tm{{ project_alias }}  - Launch tmux session
        b{{ project_alias }}   - Bootstrap project (clone, secrets, build)
        pm{{ project_alias }}  - cd to project management dir
        {{ project_alias }}    - cd to {{ project_path }}
        d{{ project_alias }}   - Docker compose up
        dd{{ project_alias }}  - Docker compose down

      Laravel files created (if missing):
        - docker-compose.yml in {{ project_path }}
        - .env in ~/.secrets/{{ project_name }}

      Next steps:
        1. Run 'b{{ project_alias }}' to bootstrap (copy secrets, build Docker)
        2. Run 'php artisan key:generate' in the container
        3. Run 'l{{ project_alias }}' to launch
  when: project_type == 'laravel'

- name: Show completion message (other types with docker)
  ansible.builtin.debug:
    msg: |
      Project '{{ project_name }}' created!

      Aliases (reload shell to use):
        l{{ project_alias }}   - Launch project (VS Code, docker, etc.)
        k{{ project_alias }}   - Kill project (stop docker, close windows)
        tm{{ project_alias }}  - Launch tmux session
        b{{ project_alias }}   - Bootstrap project (clone, secrets, build)
        pm{{ project_alias }}  - cd to project management dir
        {{ project_alias }}    - cd to {{ project_path }}
        d{{ project_alias }}   - Docker compose up
        dd{{ project_alias }}  - Docker compose down
  when: project_type != 'laravel' and docker_compose | default(false) | bool

- name: Show completion message (other types without docker)
  ansible.builtin.debug:
    msg: |
      Project '{{ project_name }}' created!

      Aliases (reload shell to use):
        l{{ project_alias }}   - Launch project (VS Code, docker, etc.)
        k{{ project_alias }}   - Kill project (stop docker, close windows)
        tm{{ project_alias }}  - Launch tmux session
        b{{ project_alias }}   - Bootstrap project (clone, secrets, build)
        pm{{ project_alias }}  - cd to project management dir
        {{ project_alias }}    - cd to {{ project_path }}
  when: project_type != 'laravel' and not (docker_compose | default(false) | bool)
