---
# Create new project management setup
# Called with: ansible-playbook playbook.yml --tags new-project -e "project_name=foo project_alias=f project_type=utility project_path=~/Projects/foo"

- name: Validate project type
  ansible.builtin.fail:
    msg: "Invalid project_type '{{ project_type }}'. Valid types: utility, laravel, python, rstats"
  when: project_type not in ['utility', 'laravel', 'python', 'rstats']

# Clone from GitHub if requested
- name: Clone project from GitHub
  ansible.builtin.git:
    repo: "git@github.com:{{ github_repo }}.git"
    dest: "{{ project_path }}"
    accept_hostkey: true
  when: github_repo is defined and github_repo | length > 0

# Create empty project directory if requested
- name: Create empty project directory
  ansible.builtin.file:
    path: "{{ create_project_dir }}"
    state: directory
    mode: '0755'
  when: create_project_dir is defined and create_project_dir | length > 0

- name: Create projects directory in repo
  ansible.builtin.file:
    path: "{{ omarchy_repo }}/projects/{{ project_name }}"
    state: directory
    mode: '0755'

- name: Generate tmux.sh from template
  ansible.builtin.template:
    src: "tmux-{{ project_type }}.sh.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/tmux.sh"
    mode: '0755'

- name: Generate launch script from template
  ansible.builtin.template:
    src: "launch.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/launch"
    mode: '0755'

- name: Generate kill script from template
  ansible.builtin.template:
    src: "kill.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/kill"
    mode: '0755'

- name: Convert project name to kebab-case for workspace file
  ansible.builtin.set_fact:
    workspace_filename: "{{ project_name | lower | regex_replace('[^a-z0-9]', '-') | regex_replace('-+', '-') | regex_replace('^-|-$', '') }}"

- name: Generate workspace file for vscode/positron
  ansible.builtin.template:
    src: "workspace.code-workspace.j2"
    dest: "{{ omarchy_repo }}/projects/{{ project_name }}/{{ workspace_filename }}.code-workspace"
    mode: '0644'
  when: project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0

# Laravel-specific: Create docker-compose.yml if it doesn't exist
- name: Check if docker-compose.yml exists in project
  ansible.builtin.stat:
    path: "{{ project_path }}/docker-compose.yml"
  register: docker_compose_stat
  when: project_type == 'laravel' and project_path | length > 0

- name: Generate docker-compose.yml for Laravel project
  ansible.builtin.template:
    src: "laravel-docker-compose.yml.j2"
    dest: "{{ project_path }}/docker-compose.yml"
    mode: '0644'
  when: project_type == 'laravel' and project_path | length > 0 and not docker_compose_stat.stat.exists

# Laravel-specific: Create .env in secrets if it doesn't exist
- name: Ensure secrets directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}"
    state: directory
    mode: '0700'
  when: project_type == 'laravel'

- name: Check if .env exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}/.env"
  register: env_secrets_stat
  when: project_type == 'laravel'

- name: Check if .env exists in project
  ansible.builtin.stat:
    path: "{{ project_path }}/.env"
  register: env_project_stat
  when: project_type == 'laravel' and project_path | length > 0

- name: Generate .env for Laravel project in secrets
  ansible.builtin.template:
    src: "laravel-env.j2"
    dest: "{{ ansible_facts.env.HOME }}/.secrets/{{ project_name }}/.env"
    mode: '0600'
  when: project_type == 'laravel' and not env_secrets_stat.stat.exists and (project_path | length == 0 or not env_project_stat.stat.exists)

- name: Add project aliases to .aliases (with project dir)
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/home/.aliases"
    marker: "# {mark} PROJECT {{ project_name }}"
    insertbefore: "# Auto-generated project aliases"
    block: |
      alias l{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/launch"
      alias k{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/kill"
      alias tm{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/tmux.sh"
      alias b{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/bootstrap"
      alias pm{{ project_alias }}="cd ~/Omarchy/projects/{{ project_name }}"
      alias {{ project_alias }}="cd {{ project_path }}"
  when: project_path | length > 0

- name: Add project aliases to .aliases (no project dir)
  ansible.builtin.blockinfile:
    path: "{{ omarchy_repo }}/home/.aliases"
    marker: "# {mark} PROJECT {{ project_name }}"
    insertbefore: "# Auto-generated project aliases"
    block: |
      alias l{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/launch"
      alias k{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/kill"
      alias tm{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/tmux.sh"
      alias b{{ project_alias }}="~/Omarchy/projects/{{ project_name }}/bootstrap"
      alias pm{{ project_alias }}="cd ~/Omarchy/projects/{{ project_name }}"
  when: project_path | length == 0

- name: Sync aliases to home
  ansible.builtin.copy:
    src: "{{ omarchy_repo }}/home/.aliases"
    dest: "{{ ansible_facts.env.HOME }}/.aliases"
    mode: '0644'

- name: Show completion message (Laravel)
  ansible.builtin.debug:
    msg: |
      Project '{{ project_name }}' created!

      Aliases (reload shell to use):
        l{{ project_alias }}   - Launch project (VS Code, docker, etc.)
        k{{ project_alias }}   - Kill project (stop docker, close windows)
        tm{{ project_alias }}  - Launch tmux session
        b{{ project_alias }}   - Bootstrap project (clone, secrets, build)
        pm{{ project_alias }}  - cd to project management dir
        {{ project_alias }}    - cd to {{ project_path }}

      Laravel files created (if missing):
        - docker-compose.yml in {{ project_path }}
        - .env in ~/.secrets/{{ project_name }}

      Next steps:
        1. Run 'b{{ project_alias }}' to bootstrap (copy secrets, build Docker)
        2. Run 'php artisan key:generate' in the container
        3. Run 'l{{ project_alias }}' to launch
  when: project_type == 'laravel'

- name: Show completion message (other types)
  ansible.builtin.debug:
    msg: |
      Project '{{ project_name }}' created!

      Aliases (reload shell to use):
        l{{ project_alias }}   - Launch project (VS Code, docker, etc.)
        k{{ project_alias }}   - Kill project (stop docker, close windows)
        tm{{ project_alias }}  - Launch tmux session
        b{{ project_alias }}   - Bootstrap project (clone, secrets, build)
        pm{{ project_alias }}  - cd to project management dir
        {{ project_alias }}    - cd to {{ project_path }}
  when: project_type != 'laravel'
