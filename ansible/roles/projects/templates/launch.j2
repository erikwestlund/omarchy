#!/bin/bash
# Launch script for {{ project_name }}

set -e

# === Project Config ===
PROJECT_NAME="{{ project_name }}"
{% if project_path | length > 0 %}
PROJECT_DIR="{{ project_path }}"
{% else %}
PROJECT_DIR="$HOME/Omarchy/projects/{{ project_name }}"
{% endif %}
{% if project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0 %}
WORKSPACE_FILE="$HOME/Omarchy/projects/{{ project_name }}/{{ project_name | lower | regex_replace('[^a-z0-9]', '-') | regex_replace('-+', '-') | regex_replace('^-|-$', '') }}.code-workspace"
{% else %}
WORKSPACE_FILE=""
{% endif %}
{% if project_editor | default('vscode') == 'positron' %}
EDITOR="/usr/share/positron/bin/positron"
{% elif project_editor | default('vscode') == 'vscode' %}
EDITOR="/usr/bin/code"
{% else %}
EDITOR="{{ project_editor | default('vscode') }}"
{% endif %}
DEFAULT_WS={{ default_ws | default(1) }}
{% if docker_compose | default(false) | bool %}
DOCKER_COMPOSE=true
{% else %}
# DOCKER_COMPOSE=false
{% endif %}
{% if view_url | default('') | length > 0 %}
VIEW_URL="{{ view_url }}"
USE_SPLIT={{ use_split | default(false) | lower }}
{% else %}
# VIEW_URL=""
# USE_SPLIT=false
{% endif %}

# === Parse Arguments ===
WS=${1:-$DEFAULT_WS}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: launch [WORKSPACE]"
    echo ""
    echo "  WORKSPACE  Workspace number (default: $DEFAULT_WS)"
    echo ""
    echo "Examples:"
    echo "  launch      # Opens in workspace $DEFAULT_WS"
    echo "  launch 3    # Opens in workspace 3"
    exit 0
fi

# === Launch ===
echo "Launching $PROJECT_NAME in workspace $WS..."

# Switch to workspace
hyprctl dispatch workspace $WS

{% if docker_compose | default(false) | bool %}
# Start Docker services
if [ -f "$PROJECT_DIR/docker-compose.dev.yml" ]; then
    echo "Starting Docker services..."
    (cd "$PROJECT_DIR" && docker compose -f docker-compose.dev.yml up -d)
elif [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "Starting Docker services..."
    (cd "$PROJECT_DIR" && docker compose up -d)
fi
{% else %}
# Start Docker services (if configured)
# if [ -f "$PROJECT_DIR/docker-compose.dev.yml" ]; then
#     echo "Starting Docker services..."
#     (cd "$PROJECT_DIR" && docker compose -f docker-compose.dev.yml up -d)
# fi
{% endif %}

# Launch editor (use hyprctl exec with workspace rule for reliable placement)
echo "Opening $EDITOR..."
{% if project_editor | default('vscode') == 'neovim' %}
hyprctl dispatch exec "[workspace $WS silent]" "ghostty -e nvim '$PROJECT_DIR'"
{% elif project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0 %}
hyprctl dispatch exec "[workspace $WS silent]" "$EDITOR '$WORKSPACE_FILE'"
{% else %}
hyprctl dispatch exec "[workspace $WS silent]" "$EDITOR '$PROJECT_DIR'"
{% endif %}

{% if view_url | default('') | length > 0 %}
# Open view in split workspace
if [ "$USE_SPLIT" = "true" ]; then
    VIEW_WS=$((WS + 1))
    echo "Opening view in workspace $VIEW_WS..."
    hyprctl dispatch exec "[workspace $VIEW_WS silent]" "xdg-open '$VIEW_URL'"
else
    echo "Opening view..."
    hyprctl dispatch exec "[workspace $WS silent]" "xdg-open '$VIEW_URL'"
fi
{% else %}
# Open view in split workspace (if configured)
# if [ "$USE_SPLIT" = "true" ] && [ -n "$VIEW_URL" ]; then
#     VIEW_WS=$((WS + 1))
#     echo "Opening view in workspace $VIEW_WS..."
#     hyprctl dispatch exec "[workspace $VIEW_WS silent]" "xdg-open '$VIEW_URL'"
# fi
{% endif %}

echo "Done! $PROJECT_NAME launched in workspace $WS"
