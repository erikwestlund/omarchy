#!/bin/bash
# Launch script for {{ project_name }}
# Generated by Ansible - edit the template, not this file

set -e

# Machine defaults (from ~/.config/omarchy/project-defaults.sh)
source ~/.config/omarchy/project-defaults.sh 2>/dev/null || true
DEFAULT_WS=${DEFAULT_WS:-1}
SPLIT_WS=${SPLIT_WS:-false}

# Project config
PROJECT_NAME="{{ project_name }}"
{% if project_path | length > 0 %}
PROJECT_DIR="{{ project_path }}"
{% else %}
PROJECT_DIR="$HOME/Omarchy/projects/{{ project_name }}"
{% endif %}
{% if docker_compose | default(false) %}
DOCKER_COMPOSE=true
{% else %}
DOCKER_COMPOSE=false
{% endif %}
{% if view_url | default('') | length > 0 %}
VIEW_URL="{{ view_url }}"
{% else %}
VIEW_URL=""
{% endif %}

# Parse bool value (0/1, t/f, y/n, true/false, yes/no - case insensitive)
parse_bool() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        1|t|y|true|yes) echo "true" ;;
        0|f|n|false|no) echo "false" ;;
        *) echo "invalid" ;;
    esac
}

# Parse arguments
WS=$DEFAULT_WS
while [[ $# -gt 0 ]]; do
    case $1 in
        --ws=*)
            WS="${1#*=}"
            shift
            ;;
        --ws)
            WS="$2"
            shift 2
            ;;
        --split=*)
            SPLIT_WS=$(parse_bool "${1#*=}")
            shift
            ;;
        --split)
            if [[ -n "$2" && ! "$2" =~ ^-- ]]; then
                SPLIT_WS=$(parse_bool "$2")
                shift 2
            else
                SPLIT_WS=true
                shift
            fi
            ;;
        --no-split)
            SPLIT_WS=false
            shift
            ;;
        -h|--help)
            echo "Usage: launch [--ws N] [--split [BOOL]]"
            echo ""
            echo "Options:"
            echo "  --ws N, --ws=N     Launch in workspace N (default: $DEFAULT_WS)"
            echo "  --split [BOOL]     Split editor/view across workspaces"
            echo "                     BOOL: 0/1, t/f, true/false (default: true)"
            echo "  --no-split         Same as --split=false"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Calculate view workspace
if [ "$SPLIT_WS" = "true" ]; then
    VIEW_WS=$((WS + 1))
else
    VIEW_WS=$WS
fi

echo "Launching $PROJECT_NAME in workspace $WS..."

# Switch to editor workspace
hyprctl dispatch workspace $WS

# Start Docker services first (they take time to spin up)
if [ "$DOCKER_COMPOSE" = "true" ] && [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "Starting Docker services..."
    (cd "$PROJECT_DIR" && docker compose up -d)
fi

# Launch VS Code
echo "Opening VS Code..."
code "$PROJECT_DIR" &

# Wait for VS Code window to appear
sleep 1.5

# Move VS Code to the correct workspace (it may have opened elsewhere)
# Find the VS Code window for this project and move it
VSCODE_ADDR=$(hyprctl clients -j | jq -r --arg dir "$PROJECT_DIR" '.[] | select(.class == "code" or .class == "Code") | select(.title | contains($dir) or contains("'$PROJECT_NAME'")) | .address' | head -1)
if [ -n "$VSCODE_ADDR" ]; then
    hyprctl dispatch movetoworkspacesilent "$WS,address:$VSCODE_ADDR"
fi

# Open view (browser) if configured
if [ -n "$VIEW_URL" ]; then
    echo "Opening view in workspace $VIEW_WS..."
    hyprctl dispatch workspace $VIEW_WS
    xdg-open "$VIEW_URL" &
    sleep 0.5
fi

# Return to editor workspace
hyprctl dispatch workspace $WS

echo "Done! $PROJECT_NAME launched in workspace $WS"
{% if view_url | default('') | length > 0 %}
echo "View opened in workspace $VIEW_WS"
{% endif %}
