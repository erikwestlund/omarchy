#!/bin/bash
# Launch script for {{ project_name }}
#
# This script launches the {{ project_name }} development environment with:
{% if docker_compose | default(false) | bool %}
# - Docker service orchestration (starts and waits for health checks)
{% endif %}
# - Editor and browser (if VIEW_URL set) on the active workspace
# - Notification system (shows progress updates)

# === Project Config ===
PROJECT_NAME="{{ project_name }}"
{% if project_path | length > 0 %}
PROJECT_DIR="{{ project_path }}"
{% else %}
PROJECT_DIR="$HOME/Omarchy/projects/{{ project_name }}"
{% endif %}
{% if project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0 %}
WORKSPACE_FILE="$HOME/Omarchy/projects/{{ project_name }}/{{ project_name | lower | regex_replace('[^a-z0-9]', '-') | regex_replace('-+', '-') | regex_replace('^-|-$', '') }}.code-workspace"
{% else %}
WORKSPACE_FILE=""
{% endif %}
{% if project_editor | default('vscode') == 'positron' %}
EDITOR="/usr/share/positron/bin/positron"
{% elif project_editor | default('vscode') == 'vscode' %}
EDITOR="/usr/bin/code"
{% else %}
EDITOR="{{ project_editor | default('vscode') }}"
{% endif %}
{% if docker_compose | default(false) | bool %}
DOCKER_COMPOSE=true
{% else %}
DOCKER_COMPOSE=false
{% endif %}
{% if view_url | default('') | length > 0 %}
VIEW_URL="{{ view_url }}"
{% else %}
VIEW_URL=""
{% endif %}

# === Launch ===
notify-send -u low "{{ project_name | replace('-', ' ') | title }}" "Launching..." -t 5000

# Start tmux session (if not already running) - run detached so it doesn't block
TMUX_SCRIPT="$HOME/Omarchy/projects/{{ project_name }}/tmux.sh"
if [ -x "$TMUX_SCRIPT" ]; then
    "$TMUX_SCRIPT" </dev/null &
    sleep 0.5
fi

# Ensure shared mailpit is running (for mail testing)
if [ "$DOCKER_COMPOSE" = "true" ]; then
    if ! docker ps --format '{{"{{"}}.Names{{"}}"}}' | grep -q '^mailpit$'; then
        docker compose -f "$HOME/Omarchy/services/mailpit/docker-compose.yml" up -d 2>/dev/null
    fi
fi

# Start Docker services (if enabled)
if [ "$DOCKER_COMPOSE" = "true" ] && [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    notify-send -u low "{{ project_name | replace('-', ' ') | title }}" "Starting Docker services..." -t 4000
    (cd "$PROJECT_DIR" && docker compose up -d) || {
        notify-send -u critical "{{ project_name | replace('-', ' ') | title }}" "Failed to start Docker services" -t 5000
        exit 1
    }

    # Wait for services to be healthy
    MAX_WAIT=60  # Maximum wait time in seconds
    ELAPSED=0
    WAITING_NOTIFIED=false

    while [ $ELAPSED -lt $MAX_WAIT ]; do
        # Check if all services with health checks are healthy
        UNHEALTHY=$(cd "$PROJECT_DIR" && docker compose ps --format json | jq -r 'select(.Health != "" and .Health != "healthy") | .Service' 2>/dev/null)

        if [ -z "$UNHEALTHY" ]; then
            break
        fi

        # Only show waiting notification if it's taking more than 4 seconds
        if [ $ELAPSED -ge 4 ] && [ "$WAITING_NOTIFIED" = false ]; then
            notify-send -u normal "{{ project_name | replace('-', ' ') | title }}" "Waiting for services..." -t 10000
            WAITING_NOTIFIED=true
        fi

        sleep 2
        ELAPSED=$((ELAPSED + 2))
    done

    if [ $ELAPSED -ge $MAX_WAIT ]; then
        notify-send -u normal "{{ project_name | replace('-', ' ') | title }}" "Services slow, opening anyway..." -t 3000
    fi
fi

# Open browser first (right side), then editor (left side)
if [ -n "$VIEW_URL" ]; then
    chromium --new-window "$VIEW_URL" &
    sleep 0.3
fi

{% if project_editor | default('vscode') in ['vscode', 'positron'] and project_path | length > 0 %}
$EDITOR "$WORKSPACE_FILE" &
{% else %}
$EDITOR "$PROJECT_DIR" &
{% endif %}

notify-send -u low "{{ project_name | replace('-', ' ') | title }}" "Ready!" -t 3000
