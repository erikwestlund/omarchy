#!/bin/bash
# Kill script for {{ project_name }}

# === Project Config ===
PROJECT_NAME="{{ project_name }}"
{% if project_path | length > 0 %}
PROJECT_DIR="{{ project_path }}"
{% else %}
PROJECT_DIR="$HOME/Omarchy/projects/{{ project_name }}"
{% endif %}
EDITOR="{{ project_editor | default('vscode') }}"
{% if docker_compose | default(false) | bool %}
DOCKER_COMPOSE=true
{% else %}
# DOCKER_COMPOSE=false
{% endif %}

echo "Stopping $PROJECT_NAME..."

{% if docker_compose | default(false) | bool %}
# Stop Docker services (docker-compose.yml = dev, docker-compose.prod.yml = prod)
if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "Stopping Docker services..."
    (cd "$PROJECT_DIR" && docker compose down)
fi
{% else %}
# Stop Docker services (if configured)
# if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
#     echo "Stopping Docker services..."
#     (cd "$PROJECT_DIR" && docker compose down)
# fi
{% endif %}

# Close editor windows for this project
echo "Closing $EDITOR..."
case "$EDITOR" in
    positron)
        EDITOR_ADDRS=$(hyprctl clients -j | jq -r '.[] | select(.class | test("positron|Positron")) | select(.title | contains("'"$PROJECT_NAME"'")) | .address')
        ;;
    code|vscode)
        EDITOR_ADDRS=$(hyprctl clients -j | jq -r '.[] | select(.class | test("code|Code")) | select(.title | contains("'"$PROJECT_NAME"'")) | .address')
        ;;
    neovim)
        EDITOR_ADDRS=$(hyprctl clients -j | jq -r '.[] | select(.class | test("ghostty")) | select(.title | contains("nvim")) | .address')
        ;;
esac

for addr in $EDITOR_ADDRS; do
    hyprctl dispatch closewindow "address:$addr" 2>/dev/null
done

echo "Done! $PROJECT_NAME stopped."
