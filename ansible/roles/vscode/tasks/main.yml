---
# VS Code / Positron settings sync via symlinks

# VS Code
- name: Ensure VS Code User directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/Code/User"
    state: directory
    mode: '0755'

- name: Remove existing VS Code settings files (to replace with symlinks)
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/Code/User/{{ item }}"
    state: absent
  loop:
    - settings.json
    - keybindings.json
    - snippets
  when: vscode_force_symlinks | default(true)

- name: Symlink VS Code settings
  ansible.builtin.file:
    src: "{{ config_src }}/vscode/{{ item }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/Code/User/{{ item }}"
    state: link
    force: true
  loop:
    - settings.json
    - keybindings.json
    - snippets

# Fix VS Code theme persistence issue
# VS Code caches theme in globalStorage/storage.json which overrides settings.json
- name: Check if VS Code globalStorage exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/Code/User/globalStorage/storage.json"
  register: vscode_storage

- name: Remove theme cache from VS Code globalStorage
  ansible.builtin.shell:
    cmd: |
      jq 'del(.theme, .themeBackground)' "{{ ansible_facts.env.HOME }}/.config/Code/User/globalStorage/storage.json" > /tmp/vscode_storage.json.tmp
      mv /tmp/vscode_storage.json.tmp "{{ ansible_facts.env.HOME }}/.config/Code/User/globalStorage/storage.json"
  when: vscode_storage.stat.exists
  changed_when: false

# Positron (separate config from VS Code)
- name: Check if Positron is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/Positron"
  register: positron_dir

- name: Ensure Positron User directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/Positron/User"
    state: directory
    mode: '0755'
  when: positron_dir.stat.exists

- name: Remove existing Positron settings files (to replace with symlinks)
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/Positron/User/{{ item }}"
    state: absent
  loop:
    - settings.json
    - keybindings.json
    - snippets
  when: positron_dir.stat.exists and (vscode_force_symlinks | default(true))

- name: Symlink Positron settings
  ansible.builtin.file:
    src: "{{ config_src }}/positron/{{ item }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/Positron/User/{{ item }}"
    state: link
    force: true
  loop:
    - settings.json
    - keybindings.json
    - snippets
  when: positron_dir.stat.exists

# Fix Positron theme persistence issue
- name: Check if Positron globalStorage exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/Positron/User/globalStorage/storage.json"
  register: positron_storage
  when: positron_dir.stat.exists

- name: Remove theme cache from Positron globalStorage
  ansible.builtin.shell:
    cmd: |
      jq 'del(.theme, .themeBackground)' "{{ ansible_facts.env.HOME }}/.config/Positron/User/globalStorage/storage.json" > /tmp/positron_storage.json.tmp
      mv /tmp/positron_storage.json.tmp "{{ ansible_facts.env.HOME }}/.config/Positron/User/globalStorage/storage.json"
  when: positron_dir.stat.exists and positron_storage.stat.exists
  changed_when: false

# Extensions (optional - run with -e "vscode_install_extensions=true")
- name: Read extensions list
  ansible.builtin.slurp:
    src: "{{ config_src }}/vscode/extensions.txt"
  register: extensions_file
  when: vscode_install_extensions | default(false)

- name: Install VS Code extensions
  ansible.builtin.command:
    cmd: "code --install-extension {{ item }}"
  loop: "{{ (extensions_file.content | b64decode).split('\n') | select('match', '.+') | list }}"
  register: ext_result
  changed_when: "'was successfully installed' in ext_result.stdout"
  failed_when: false
  when: vscode_install_extensions | default(false)
