---
# Deploy secrets configuration and pull from B2

- name: Ensure secrets config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/secrets"
    state: directory
    mode: '0700'

- name: Deploy secrets config
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.config/secrets/config"
    mode: '0600'
    content: |
      # B2 credentials
      B2_KEY_ID="{{ vault_b2_key_id }}"
      B2_APP_KEY="{{ vault_b2_app_key }}"
      B2_BUCKET="{{ vault_b2_bucket }}"

      # Age encryption keys
      AGE_SECRET_KEY="{{ vault_age_secret_key }}"
      AGE_PUBLIC_KEY="{{ vault_age_public_key }}"
  no_log: true

- name: Pull secrets from B2 (always sync to ensure up to date)
  ansible.builtin.command:
    cmd: "{{ ansible_facts.env.HOME }}/.bin/secrets-pull"
  changed_when: true

# SSH setup - symlink entire directory
- name: Check if SSH directory exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/ssh"
  register: ssh_secrets_dir

- name: Remove existing ~/.ssh if not a symlink
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.ssh"
    state: absent
  when: ssh_secrets_dir.stat.exists and ssh_secrets_dir.stat.isdir

- name: Link SSH directory
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.secrets/ssh"
    dest: "{{ ansible_facts.env.HOME }}/.ssh"
    state: link
    force: true
  when: ssh_secrets_dir.stat.exists

- name: Set SSH directory permissions
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.secrets/ssh"
    mode: '0700'
  when: ssh_secrets_dir.stat.exists

- name: Set SSH private key permissions
  ansible.builtin.shell: |
    find {{ ansible_facts.env.HOME }}/.secrets/ssh -type f ! -name "*.pub" ! -name "config" ! -name "known_hosts*" ! -name "authorized_keys" -exec chmod 600 {} \;
  when: ssh_secrets_dir.stat.exists
  changed_when: false

- name: Set SSH public file permissions
  ansible.builtin.shell: |
    find {{ ansible_facts.env.HOME }}/.secrets/ssh -type f \( -name "*.pub" -o -name "config" -o -name "known_hosts*" -o -name "authorized_keys" \) -exec chmod 644 {} \;
  when: ssh_secrets_dir.stat.exists
  changed_when: false

# AWS setup - symlink directory
- name: Check if AWS directory exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/aws"
  register: aws_secrets_dir

- name: Remove existing ~/.aws if not a symlink
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.aws"
    state: absent
  when: aws_secrets_dir.stat.exists and aws_secrets_dir.stat.isdir

- name: Link AWS directory
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.secrets/aws"
    dest: "{{ ansible_facts.env.HOME }}/.aws"
    state: link
    force: true
  when: aws_secrets_dir.stat.exists

- name: Set AWS directory permissions
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.secrets/aws"
    mode: '0700'
  when: aws_secrets_dir.stat.exists

- name: Set AWS file permissions
  ansible.builtin.shell: |
    find {{ ansible_facts.env.HOME }}/.secrets/aws -type f -exec chmod 600 {} \;
  when: aws_secrets_dir.stat.exists
  changed_when: false

# Rclone setup - symlink directory
- name: Check if rclone directory exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/rclone"
  register: rclone_secrets_dir

- name: Ensure ~/.config exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config"
    state: directory
    mode: '0755'

- name: Remove existing ~/.config/rclone if not a symlink
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/rclone"
    state: absent
  when: rclone_secrets_dir.stat.exists and rclone_secrets_dir.stat.isdir

- name: Link rclone directory
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.secrets/rclone"
    dest: "{{ ansible_facts.env.HOME }}/.config/rclone"
    state: link
    force: true
  when: rclone_secrets_dir.stat.exists

- name: Set rclone directory permissions
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.secrets/rclone"
    mode: '0700'
  when: rclone_secrets_dir.stat.exists

- name: Set rclone file permissions
  ansible.builtin.shell: |
    find {{ ansible_facts.env.HOME }}/.secrets/rclone -type f -exec chmod 600 {} \;
  when: rclone_secrets_dir.stat.exists
  changed_when: false

# GPG setup
- name: Ensure GPG directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.gnupg"
    state: directory
    mode: '0700'

- name: Check if GPG key exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/gpg/private.asc"
  register: gpg_key_secret

- name: Import GPG key from secrets
  ansible.builtin.shell: |
    gpg --batch --import {{ ansible_facts.env.HOME }}/.secrets/gpg/private.asc
  when: gpg_key_secret.stat.exists
  changed_when: false
  failed_when: false
  no_log: true

# /etc/hosts management
- name: Check if hosts file exists in secrets
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.secrets/hosts"
  register: hosts_secret

- name: Deploy /etc/hosts from secrets
  ansible.builtin.copy:
    src: "{{ ansible_facts.env.HOME }}/.secrets/hosts"
    dest: /etc/hosts
    mode: '0644'
  become: true
  when: hosts_secret.stat.exists

# Git config for SSH
- name: Configure git to use SSH for GitHub
  community.general.git_config:
    name: url."git@github.com:".insteadOf
    value: "https://github.com/"
    scope: global

# Docker registry authentication
- name: Ensure docker config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.docker"
    state: directory
    mode: '0700'

- name: Login to GitHub Container Registry
  ansible.builtin.shell: |
    echo "{{ github_pat | default('') }}" | docker login ghcr.io -u {{ github_username | default('') }} --password-stdin
  no_log: true
  changed_when: false
  when: github_pat is defined and github_username is defined
