---
# Sync dotfiles from repo to system

- name: Check if machine identifier exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.machine"
  register: machine_file

- name: Create machine identifier file (only if missing)
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.machine"
    content: "{{ inventory_hostname }}"
    mode: '0644'
  when: not machine_file.stat.exists

# Theme setup - must run BEFORE hypr config sync to avoid race condition
# (Hyprland auto-reloads when config files change, needs theme to exist)
- name: Ensure omarchy config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/omarchy"
    state: directory
    mode: '0755'

- name: Ensure omarchy current directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/omarchy/current"
    state: directory
    mode: '0755'
  when: theme_name is defined

- name: Check if theme path exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/theme"
  register: theme_path
  when: theme_name is defined

# Migrate existing directory to symlink structure (one-time migration)
# This must happen BEFORE hypr config syncs to avoid race condition
- name: Migrate theme directory to symlink structure
  ansible.builtin.shell: |
    cd {{ ansible_facts.env.HOME }}/.config/omarchy/current
    mv theme theme-active
    ln -s theme-active theme
  when:
    - theme_name is defined
    - theme_path.stat.exists | default(false)
    - theme_path.stat.isdir | default(false)
    - not (theme_path.stat.islnk | default(false))

# Bootstrap theme only if it doesn't exist at all (first run)
- name: Bootstrap theme-active directory (first run only)
  ansible.builtin.copy:
    src: "{{ ansible_facts.env.HOME }}/.config/omarchy/themes/{{ theme_name }}/"
    dest: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/theme-active/"
    remote_src: true
    mode: preserve
  when:
    - theme_name is defined
    - not (theme_path.stat.exists | default(false))

- name: Bootstrap theme symlink (first run only)
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/theme-active"
    dest: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/theme"
    state: link
  when:
    - theme_name is defined
    - not (theme_path.stat.exists | default(false))

- name: Set theme background
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/theme/backgrounds/{{ theme_background }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/omarchy/current/background"
    state: link
    force: true
  when: theme_background is defined

# Config directories that need ansible processing (templates, mode changes)
- name: Check which config directories to copy exist
  ansible.builtin.stat:
    path: "{{ config_src }}/{{ item }}"
  loop: "{{ config_dirs_copy }}"
  register: config_dir_copy_stats

- name: Copy config directories to ~/.config/ (processed by ansible)
  ansible.builtin.copy:
    src: "{{ config_src }}/{{ item.item }}/"
    dest: "{{ ansible_facts.env.HOME }}/.config/{{ item.item }}/"
    mode: preserve
  loop: "{{ config_dir_copy_stats.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.stat.exists and item.stat.isdir
  register: config_sync_results

# Config directories that can be symlinked (no ansible processing)
- name: Check which config directories to symlink exist
  ansible.builtin.stat:
    path: "{{ config_src }}/{{ item }}"
  loop: "{{ config_dirs_symlink }}"
  register: config_dir_symlink_stats

- name: Check existing config directories for symlink candidates
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/{{ item }}"
  loop: "{{ config_dirs_symlink }}"
  register: existing_config_dirs

- name: Remove existing directories that should be symlinks
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/{{ item.item }}"
    state: absent
  loop: "{{ existing_config_dirs.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.stat.exists and item.stat.isdir and not item.stat.islnk

- name: Symlink config directories to ~/.config/
  ansible.builtin.file:
    src: "{{ config_src }}/{{ item.item }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/{{ item.item }}"
    state: link
    force: true
  loop: "{{ config_dir_symlink_stats.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.stat.exists and item.stat.isdir

- name: Symlink starship config
  ansible.builtin.file:
    src: "{{ config_src }}/starship.toml"
    dest: "{{ ansible_facts.env.HOME }}/.config/starship.toml"
    state: link
    force: true

- name: Symlink mimeapps.list (default applications)
  ansible.builtin.file:
    src: "{{ config_src }}/mimeapps.list"
    dest: "{{ ansible_facts.env.HOME }}/.config/mimeapps.list"
    state: link
    force: true

# OpenCode config (copy file, not directory - OpenCode creates its own files there)
- name: Ensure opencode config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/opencode"
    state: directory
    mode: '0755'

- name: Copy opencode config file
  ansible.builtin.copy:
    src: "{{ config_src }}/opencode/opencode.json"
    dest: "{{ ansible_facts.env.HOME }}/.config/opencode/opencode.json"
    mode: '0644'

# Neovim plugin overrides (LazyVim owns the directory, we just add specific files)
- name: Ensure nvim plugins directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/nvim/lua/plugins"
    state: directory
    mode: '0755'

- name: Find nvim plugin override files in repo
  ansible.builtin.find:
    paths: "{{ config_src }}/nvim/lua/plugins"
    patterns: "*.lua"
  register: nvim_plugin_files

- name: Symlink nvim plugin overrides
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/nvim/lua/plugins/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ nvim_plugin_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

# Sublime Text config (nested path structure)
- name: Ensure Sublime Text User config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/sublime-text/Packages/User"
    state: directory
    mode: '0755'

- name: Find Sublime Text config files in repo
  ansible.builtin.find:
    paths: "{{ config_src }}/sublime-text/Packages/User"
    patterns: "*"
    file_type: file
  register: sublime_files

- name: Symlink Sublime Text User config files
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ ansible_facts.env.HOME }}/.config/sublime-text/Packages/User/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ sublime_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Deploy host-specific Hyprland config
  ansible.builtin.template:
    src: looknfeel-host.conf.j2
    dest: "{{ ansible_facts.env.HOME }}/.config/hypr/looknfeel-host.conf"
    mode: '0644'
  register: hypr_host_config

- name: Deploy host-specific hypridle config (laptop suspend fix)
  ansible.builtin.template:
    src: hypridle.conf.j2
    dest: "{{ ansible_facts.env.HOME }}/.config/hypr/hypridle.conf"
    mode: '0644'
  when: hypridle_after_sleep_delay is defined

- name: Enable and start hypridle user service
  ansible.builtin.systemd:
    name: hypridle
    scope: user
    enabled: true
    state: started

- name: Deploy host-specific Waybar CSS
  ansible.builtin.template:
    src: waybar-host.css.j2
    dest: "{{ ansible_facts.env.HOME }}/.config/waybar/waybar-host.css"
    mode: '0644'
  register: waybar_host_config

- name: Update waybar config.jsonc margins and height
  ansible.builtin.replace:
    path: "{{ ansible_facts.env.HOME }}/.config/waybar/config.jsonc"
    regexp: '"margin-left": \d+'
    replace: '"margin-top": {{ waybar_json_margin_top | default(2) }},\n  "margin-left": {{ waybar_json_margin_x | default(2) }}'
  when: waybar_json_margin_x is defined or waybar_json_margin_top is defined

- name: Update waybar config.jsonc margin-right
  ansible.builtin.replace:
    path: "{{ ansible_facts.env.HOME }}/.config/waybar/config.jsonc"
    regexp: '"margin-right": \d+'
    replace: '"margin-right": {{ waybar_json_margin_x | default(2) }}'
  when: waybar_json_margin_x is defined

- name: Update waybar config.jsonc height
  ansible.builtin.replace:
    path: "{{ ansible_facts.env.HOME }}/.config/waybar/config.jsonc"
    regexp: '"height": \d+'
    replace: '"height": {{ waybar_json_height | default(22) }}'
  when: waybar_json_height is defined

- name: Add battery module to waybar on laptops
  ansible.builtin.replace:
    path: "{{ ansible_facts.env.HOME }}/.config/waybar/config.jsonc"
    regexp: '"cpu",(\s*)"custom/darkman"'
    replace: '"cpu",\1"battery",\1"custom/darkman"'
  when: show_battery | default(false)

- name: Add extra spacing to CPU icon on desktop (no battery)
  ansible.builtin.replace:
    path: "{{ ansible_facts.env.HOME }}/.config/waybar/config.jsonc"
    regexp: '"format": "󰍛 "'
    replace: '"format": "󰍛   "'
  when: not (show_battery | default(false))

- name: Check which home dotfiles exist
  ansible.builtin.stat:
    path: "{{ home_src }}/{{ item }}"
  loop: "{{ home_dotfiles }}"
  register: home_file_stats

- name: Symlink home dotfiles to ~/
  ansible.builtin.file:
    src: "{{ home_src }}/{{ item.item }}"
    dest: "{{ ansible_facts.env.HOME }}/{{ item.item }}"
    state: link
    force: true
  loop: "{{ home_file_stats.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.stat.exists and item.stat.isreg

- name: Sync SSH config
  ansible.builtin.copy:
    src: "{{ home_src }}/.ssh/config"
    dest: "{{ ansible_facts.env.HOME }}/.ssh/config"
    mode: '0600'

- name: Remove old ~/bin if exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/bin"
    state: absent

- name: Check if .bin exists and is not a symlink
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.bin"
  register: bin_dir_stat

- name: Remove .bin directory if not a symlink
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.bin"
    state: absent
  when: bin_dir_stat.stat.exists and not bin_dir_stat.stat.islnk

- name: Ensure bin scripts are executable
  ansible.builtin.file:
    path: "{{ home_src }}/bin"
    mode: '0755'
    recurse: true

- name: Symlink ~/.bin scripts
  ansible.builtin.file:
    src: "{{ home_src }}/bin"
    dest: "{{ ansible_facts.env.HOME }}/.bin"
    state: link
    force: true

- name: Override omarchy-theme-set with atomic swap version
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/omarchy-theme-set"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-theme-set"
    state: link
    force: true

- name: Override omarchy screensaver with custom version
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/omarchy-cmd-screensaver"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-cmd-screensaver"
    state: link
    force: true

- name: Override omarchy browser theme to use device preference
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/omarchy-theme-set-browser"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-theme-set-browser"
    state: link
    force: true

- name: Override omarchy gnome theme to use darkman mode
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/omarchy-theme-set-gnome"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-theme-set-gnome"
    state: link
    force: true

- name: Override omarchy power profiles list with custom version
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/omarchy-powerprofiles-list"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-powerprofiles-list"
    state: link
    force: true

- name: Override powerprofilesctl with custom wrapper
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.bin/powerprofilesctl"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/powerprofilesctl"
    state: link
    force: true

- name: Make hypr scripts executable
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/hypr/scripts"
    mode: '0755'
    recurse: true
  when: config_sync_results.results | selectattr('item.item', 'equalto', 'hypr') | list | length > 0

- name: Check if system directory exists
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/../system"
  register: system_dir_stat

- name: Sync system files (requires become)
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../system/"
    dest: "/"
    mode: preserve
  become: true
  when: system_dir_stat.stat.exists and system_dir_stat.stat.isdir
  notify: reload udev rules

- name: Deploy CPU governor systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/cpu-governor.service
    mode: '0644'
    content: |
      [Unit]
      Description=Set CPU governor to {{ cpu_governor }}
      After=multi-user.target

      [Service]
      Type=oneshot
      ExecStart=/bin/sh -c 'echo {{ cpu_governor }} | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor'
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
  become: true
  when: cpu_governor is defined

- name: Enable CPU governor service
  ansible.builtin.systemd:
    name: cpu-governor.service
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when: cpu_governor is defined

# btrfs-cleaner runs at normal I/O priority by default, which causes lag
# when cleaning up deleted snapshots. Set it to idle priority so it only
# runs when the system is otherwise idle.
- name: Deploy btrfs-cleaner ionice service
  ansible.builtin.copy:
    dest: /etc/systemd/system/btrfs-cleaner-ionice.service
    mode: '0644'
    content: |
      [Unit]
      Description=Set btrfs-cleaner to idle I/O priority
      After=local-fs.target

      [Service]
      Type=oneshot
      ExecStart=/bin/sh -c 'pid=$(pgrep -x btrfs-cleaner) && ionice -c 3 -p $pid || true'
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
  become: true

- name: Enable btrfs-cleaner ionice service
  ansible.builtin.systemd:
    name: btrfs-cleaner-ionice.service
    enabled: true
    state: started
    daemon_reload: true
  become: true

# Laptop power management via power-profiles-daemon
- name: Enable power-profiles-daemon
  ansible.builtin.systemd:
    name: power-profiles-daemon.service
    enabled: true
    state: started
  become: true
  when: use_power_profiles_daemon | default(false)

- name: Enable agenda sync timer
  ansible.builtin.systemd:
    name: agenda-sync.timer
    enabled: true
    state: started
    scope: user
    daemon_reload: true

- name: Enable darkman for dark/light mode
  ansible.builtin.systemd:
    name: darkman.service
    enabled: true
    state: started
    scope: user

- name: Ensure darkman data directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/darkman"
    state: directory
    mode: '0755'

- name: Check if darkman mode file exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.local/share/darkman/mode"
  register: darkman_mode_file

- name: Set default darkman mode to light (first run only)
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.local/share/darkman/mode"
    content: "light"
    mode: '0644'
  when: not darkman_mode_file.stat.exists

- name: Deploy darkman mode scripts
  ansible.builtin.copy:
    src: "{{ omarchy_repo }}/local/share/darkman/"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/darkman/"
    mode: '0755'

- name: Ensure applications directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications"
    state: directory
    mode: '0755'

- name: Find desktop file overrides
  ansible.builtin.find:
    paths: "{{ config_src }}/applications"
    patterns: "*.desktop"
  register: desktop_files

- name: Symlink desktop file overrides
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/applications/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ desktop_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Ensure icons directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/icons"
    state: directory
    mode: '0755'

- name: Find icon files
  ansible.builtin.find:
    paths: "{{ omarchy_repo }}/local/share/icons"
    patterns: "*.png,*.webp,*.ico,*.svg"
  register: icon_files

- name: Symlink icon files
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ ansible_facts.env.HOME }}/.local/share/icons/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ icon_files.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Remove old darkman script directories
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/.config/darkman/{{ item }}"
    state: absent
  loop:
    - light-mode.d
    - dark-mode.d

# Project launcher defaults
- name: Deploy project launcher defaults
  ansible.builtin.template:
    src: project-defaults.sh.j2
    dest: "{{ ansible_facts.env.HOME }}/.config/omarchy/project-defaults.sh"
    mode: '0644'

# Apply theme (symlinks already set up at start of playbook)
- name: Apply theme
  ansible.builtin.command:
    cmd: "{{ ansible_facts.env.HOME }}/.local/share/omarchy/bin/omarchy-theme-set {{ theme_name }}"
  when: theme_name is defined
  changed_when: true

- name: Ensure Screenshots directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/Screenshots"
    state: directory
    mode: '0755'

- name: Ensure Code directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/Code"
    state: directory
    mode: '0755'

# Remove unwanted XDG directories
- name: Remove unwanted home directories
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}"
    state: absent
  loop:
    - Templates
    - Videos
    - Pictures
    - Public
    - Wallpapers
    - Games
    - intelephense

# Go modules are installed read-only; need shell to force removal
- name: Remove ~/go directory if exists (Go modules are read-only)
  ansible.builtin.shell: |
    if [ -d "{{ ansible_facts.env.HOME }}/go" ]; then
      chmod -R +w "{{ ansible_facts.env.HOME }}/go" 2>/dev/null || true
      rm -rf "{{ ansible_facts.env.HOME }}/go"
    fi
  args:
    removes: "{{ ansible_facts.env.HOME }}/go"

- name: Disable XDG user dirs recreation
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.config/user-dirs.dirs"
    mode: '0644'
    content: |
      XDG_DESKTOP_DIR="$HOME/Desktop"
      XDG_DOWNLOAD_DIR="$HOME/Downloads"
      XDG_TEMPLATES_DIR="$HOME"
      XDG_PUBLICSHARE_DIR="$HOME"
      XDG_DOCUMENTS_DIR="$HOME/Documents"
      XDG_MUSIC_DIR="$HOME/Music"
      XDG_PICTURES_DIR="$HOME"
      XDG_VIDEOS_DIR="$HOME"

# Framework 13 AMD mic fix - disable UCM to make internal DMIC work
# See: https://community.frame.work/t/laptop13-ryzen-ai-340-internal-mic-in-fedora42-doesnt-work/75748
- name: Deploy Framework laptop mic fix (disable UCM)
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.config/wireplumber/wireplumber.conf.d/50-framework-mic-fix.conf"
    mode: '0644'
    content: |
      # Fix internal microphone on Framework 13 AMD
      # Disabling UCM allows the DMIC to be properly detected
      monitor.alsa.properties = {
        alsa.use-ucm = false
      }
  when: is_framework | default(false)
  notify: restart wireplumber

- name: Prevent xdg-user-dirs-update from running
  ansible.builtin.copy:
    dest: "{{ ansible_facts.env.HOME }}/.config/user-dirs.conf"
    mode: '0644'
    content: |
      enabled=False

# GTK/GNOME settings
- name: Set GTK4 file chooser to sort directories first
  community.general.dconf:
    key: "/org/gtk/gtk4/settings/file-chooser/sort-directories-first"
    value: "true"
    state: present

- name: Set GTK3 file chooser to sort directories first
  community.general.dconf:
    key: "/org/gtk/settings/file-chooser/sort-directories-first"
    value: "true"
    state: present
