# keyd Role

Configures keyd for keyboard remapping.

## CRITICAL: Never Edit /etc/keyd/ Directly

**ALWAYS deploy keyd configs via ansible.** Never edit `/etc/keyd/*.conf` files directly on the system.

If you edit system files directly and then restart keyd or reboot, the configuration can get into a broken state where Hyprland reads from both the physical keyboard AND keyd's virtual keyboard, causing keyd remapping to fail completely.

The correct workflow:
1. Edit configs in `system/etc/keyd/` or templates in `ansible/roles/keyd/templates/`
2. Run ansible: `ANSIBLE_CONFIG=~/Omarchy/ansible/ansible.cfg ansible-playbook ~/Omarchy/ansible/playbook.yml -l desktop --tags keyd`
3. Ansible will copy configs AND reload keyd properly

## Restarting keyd (IMPORTANT)

After modifying keyd configs, you MUST restart both services:

```bash
# 1. Restart the system keyd service
sudo systemctl restart keyd

# 2. Restart keyd-application-mapper (for VS Code/app-specific bindings)
pkill -f keyd-application-mapper
nohup keyd-application-mapper &>/dev/null &

# 3. Verify both are running
systemctl status keyd --no-pager | head -5
ps aux | grep "[k]eyd-application-mapper"
```

**Quick one-liner:**
```bash
sudo systemctl restart keyd && pkill -f keyd-application-mapper; nohup keyd-application-mapper &>/dev/null &
```

## Config Files

- `/etc/keyd/*.conf` - System keyd configs (copied from `system/etc/keyd/` or generated by ansible)
- `~/.config/keyd/app.conf` - App-specific bindings for keyd-application-mapper (deployed by ansible)

## Keyboard Configuration

Each machine defines a `keyboards` list in its host_vars specifying which keyboard configs to deploy:

```yaml
keyboards:
  - framework    # Framework laptop internal keyboard
  - logitech     # Logitech USB receiver
```

## Template Naming Convention

Logitech keyboards use machine-specific templates because different machines may have different receivers/keyboards with different layouts:

- `logitech-{{ inventory_hostname }}.conf.j2` - Machine-specific Logitech config

For example:
- `logitech-desktop.conf.j2` - Desktop's Logitech Bolt receiver (no alt/super swap)
- `logitech-laptop.conf.j2` - Laptop's external Logitech keyboard (with alt/super swap)

The Framework keyboard uses a shared template since it's consistent across Framework laptops:
- `framework.conf.j2` - Framework laptop internal keyboard

## Adding a New Machine

1. Add the machine to inventory.yml
2. Create `host_vars/{{ machine_name }}.yml` with `keyboards` list
3. If using Logitech, create `templates/logitech-{{ machine_name }}.conf.j2`
