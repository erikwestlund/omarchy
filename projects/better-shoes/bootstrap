#!/bin/bash
# Bootstrap script for better-shoes - ensures project is ready to run
# Run this on a fresh machine or when setting up the project

set -e

# === Project Config ===
PROJECT_NAME="better-shoes"
PROJECT_DIR="/home/erik/Projects/better-shoes"
GIT_REPO="git@github.com:letsrun/better-shoes.git"
SECRETS_DIR="$HOME/.secrets/better-shoes"

# Required secrets (relative to SECRETS_DIR -> PROJECT_DIR)
SECRETS=(
    ".env"
)

# Optional secrets (won't fail if missing)
OPTIONAL_SECRETS=(
    "auth.json"
)

echo "Bootstrapping $PROJECT_NAME..."

# === 1. Ensure repo is cloned ===
if [ -d "$PROJECT_DIR/.git" ]; then
    echo "[OK] Repository already exists at $PROJECT_DIR"
else
    echo "[...] Cloning repository..."
    mkdir -p "$(dirname "$PROJECT_DIR")"
    git clone "$GIT_REPO" "$PROJECT_DIR"
    echo "[OK] Repository cloned"
fi

# === 2. Generate docker-compose.yml ===
echo "[...] Generating docker-compose.yml..."
cat > "$PROJECT_DIR/docker-compose.yml" << 'DOCKER_COMPOSE_EOF'
services:
  php:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: better-shoes-php
    restart: on-failure
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - better-shoes-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - PHP_MEMORY_LIMIT=512M

  nginx:
    image: nginx:alpine
    container_name: better-shoes-nginx
    restart: on-failure
    ports:
      - "127.0.0.1:8020:80"
    volumes:
      - ./:/var/www/html:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - better-shoes-network
    depends_on:
      - php

  postgres:
    image: postgres:17-alpine
    container_name: better-shoes-postgres
    restart: on-failure
    environment:
      POSTGRES_DB: better_shoes
      POSTGRES_USER: better_shoes
      POSTGRES_PASSWORD: better-shoes-dev-secret
    volumes:
      - ${DOCKER_DATA_DIR:-./storage/docker}/postgres:/var/lib/postgresql/data
      - ./storage/app/dumps:/dumps
    ports:
      - "127.0.0.1:5433:5432"
    networks:
      - better-shoes-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U better_shoes -d better_shoes"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: better-shoes-redis
    restart: on-failure
    volumes:
      - ${DOCKER_DATA_DIR:-./storage/docker}/redis:/data
    ports:
      - "127.0.0.1:6380:6379"
    networks:
      - better-shoes-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: better-shoes-meilisearch
    restart: on-failure
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: better-shoes-dev-secret
      MEILI_NO_ANALYTICS: true
    volumes:
      - ${DOCKER_DATA_DIR:-./storage/docker}/meilisearch:/meili_data
    ports:
      - "127.0.0.1:7700:7700"
    networks:
      - better-shoes-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  mailpit:
    image: axllent/mailpit:latest
    container_name: better-shoes-mailpit
    restart: on-failure
    ports:
      - "127.0.0.1:1026:1025"
      - "127.0.0.1:8026:8025"
    networks:
      - better-shoes-network

  # R Executor for statistical processing (from upstream)
  r-executor:
    image: ghcr.io/letsrun/better-shoes-r-executor:latest
    container_name: better-shoes-r-executor
    platform: linux/amd64
    volumes:
      - .:/app:rw
      - ./.env:/app/.env:ro
    networks:
      - better-shoes-network
    environment:
      - DOCKER_CONTAINER=true
      - DB_HOST=postgres
      - DB_DATABASE=better_shoes
      - DB_USERNAME=better_shoes
      - DB_PASSWORD=better-shoes-dev-secret
      - DB_PORT=5432
    restart: on-failure
    depends_on:
      postgres:
        condition: service_healthy
    command: tail -f /dev/null

networks:
  better-shoes-network:
    driver: bridge
DOCKER_COMPOSE_EOF
echo "[OK] docker-compose.yml generated"

# === 3. Copy Docker configs from pequod (reference project) ===
REFERENCE_PROJECT="$HOME/Projects/pequod"
if [ -d "$REFERENCE_PROJECT/docker/php" ]; then
    echo "[...] Copying Docker PHP config..."
    mkdir -p "$PROJECT_DIR/docker/php"
    cp "$REFERENCE_PROJECT/docker/php/Dockerfile" "$PROJECT_DIR/docker/php/" 2>/dev/null || true
    cp "$REFERENCE_PROJECT/docker/php/php.ini" "$PROJECT_DIR/docker/php/" 2>/dev/null || true
    echo "[OK] Docker PHP config copied"
fi

if [ -d "$REFERENCE_PROJECT/docker/nginx" ]; then
    echo "[...] Copying Docker nginx config..."
    mkdir -p "$PROJECT_DIR/docker/nginx"
    cp "$REFERENCE_PROJECT/docker/nginx/default.conf" "$PROJECT_DIR/docker/nginx/" 2>/dev/null || true
    echo "[OK] Docker nginx config copied"
fi

# === 4. Ensure secrets are in place ===
if [ ! -d "$SECRETS_DIR" ]; then
    echo "[WARN] Secrets directory not found: $SECRETS_DIR"
    echo "       Create it and add required files, or run 'secrets-pull' if using B2"
else
    for secret in "${SECRETS[@]}"; do
        src="$SECRETS_DIR/$secret"
        dest="$PROJECT_DIR/$secret"

        if [ ! -f "$src" ]; then
            echo "[WARN] Secret not found: $src"
            continue
        fi

        if [ -f "$dest" ]; then
            if cmp -s "$src" "$dest"; then
                echo "[OK] Secret already in place: $secret"
            else
                echo "[...] Updating secret: $secret"
                cp "$src" "$dest"
                chmod 600 "$dest"
                echo "[OK] Secret updated: $secret"
            fi
        else
            echo "[...] Copying secret: $secret"
            cp "$src" "$dest"
            chmod 600 "$dest"
            echo "[OK] Secret copied: $secret"
        fi
    done

    # Copy optional secrets if they exist
    for secret in "${OPTIONAL_SECRETS[@]}"; do
        src="$SECRETS_DIR/$secret"
        dest="$PROJECT_DIR/$secret"

        if [ -f "$src" ]; then
            if [ -f "$dest" ]; then
                if cmp -s "$src" "$dest"; then
                    echo "[OK] Optional secret already in place: $secret"
                else
                    echo "[...] Updating optional secret: $secret"
                    cp "$src" "$dest"
                    chmod 600 "$dest"
                    echo "[OK] Optional secret updated: $secret"
                fi
            else
                echo "[...] Copying optional secret: $secret"
                cp "$src" "$dest"
                chmod 600 "$dest"
                echo "[OK] Optional secret copied: $secret"
            fi
        else
            echo "[SKIP] Optional secret not found (skipping): $secret"
        fi
    done
fi

# === 5. Create Docker data directory ===
if [ -f "$PROJECT_DIR/.env" ]; then
    DOCKER_DATA_DIR=$(grep '^DOCKER_DATA_DIR=' "$PROJECT_DIR/.env" | cut -d'=' -f2)
    if [ -n "$DOCKER_DATA_DIR" ] && [ ! -d "$DOCKER_DATA_DIR" ]; then
        echo "[...] Creating Docker data directory: $DOCKER_DATA_DIR"
        sudo mkdir -p "$DOCKER_DATA_DIR"
        sudo chown "$USER:$USER" "$DOCKER_DATA_DIR"
        echo "[OK] Docker data directory created"
    elif [ -n "$DOCKER_DATA_DIR" ]; then
        echo "[OK] Docker data directory exists: $DOCKER_DATA_DIR"
    fi
fi

# === 6. Build Docker images ===
if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "[...] Building Docker images..."
    (cd "$PROJECT_DIR" && docker compose build)
    echo "[OK] Docker images built"
else
    echo "[SKIP] No docker-compose.yml found"
fi

# === 7. Start Docker services ===
echo "[...] Starting Docker services..."
(cd "$PROJECT_DIR" && docker compose up -d)
echo "[OK] Docker services started"

# Fix permissions on directories that Docker may have created as root
if [ -d "$PROJECT_DIR/storage" ]; then
    echo "[...] Fixing storage permissions..."
    sudo chown -R "$(id -u):$(id -g)" "$PROJECT_DIR/storage"
    echo "[OK] Storage permissions fixed"
fi

# Create media symlink for local filesystem storage
if [ ! -L "$PROJECT_DIR/public/media" ]; then
    echo "[...] Creating media symlink..."
    mkdir -p "$PROJECT_DIR/storage/app/media"
    ln -sf "$PROJECT_DIR/storage/app/media" "$PROJECT_DIR/public/media"
    echo "[OK] Media symlink created"
fi

# Wait for PHP container to be ready
echo "[...] Waiting for services to be healthy..."
sleep 5

# === 8. Install PHP dependencies ===
if [ -f "$PROJECT_DIR/composer.json" ]; then
    echo "[...] Installing PHP dependencies..."
    (cd "$PROJECT_DIR" && docker compose exec -T php composer install --no-interaction --prefer-dist --optimize-autoloader)
    echo "[OK] PHP dependencies installed"
else
    echo "[SKIP] No composer.json found"
fi

# === 9. Install Node dependencies ===
if [ -f "$PROJECT_DIR/package.json" ]; then
    echo "[...] Installing Node dependencies..."
    (cd "$PROJECT_DIR" && docker compose exec -T php npm install)
    echo "[OK] Node dependencies installed"
else
    echo "[SKIP] No package.json found"
fi

echo ""
echo "Bootstrap complete! Run 'lbs' to start better-shoes."
echo ""
echo "Services:"
echo "  - App: http://better-shoes.test (nginx on port 8020)"
echo "  - Meilisearch: http://localhost:7700"
echo "  - Mailpit: http://localhost:8026"
