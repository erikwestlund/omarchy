#!/bin/bash
# Launch script for pequod
#
# This script launches the pequod development environment with:
# - Docker service orchestration (starts and waits for health checks)
# - Editor and browser on the active workspace
# - Notification system (shows progress updates)

# === Project Config ===
PROJECT_NAME="pequod"
PROJECT_DIR="/home/erik/Projects/pequod"
WORKSPACE_FILE="$HOME/Omarchy/projects/pequod/pequod.code-workspace"
EDITOR="/usr/bin/code"
DOCKER_COMPOSE=true
VIEW_URL="http://academic.test/admin"

# === Launch ===
notify-send -u low "Pequod" "Launching..." -t 5000

# Start tmux session (if not already running)
TMUX_SCRIPT="$HOME/Omarchy/projects/pequod/tmux.sh"
if [ -x "$TMUX_SCRIPT" ]; then
    "$TMUX_SCRIPT" </dev/null 2>/dev/null &
    sleep 0.5
fi

# Ensure shared mailpit is running (for mail testing)
if [ "$DOCKER_COMPOSE" = "true" ]; then
    if ! docker ps --format '{{.Names}}' | grep -q '^mailpit$'; then
        docker compose -f "$HOME/Omarchy/services/mailpit/docker-compose.yml" up -d 2>/dev/null
    fi
fi

# Start Docker services (docker-compose.yml = dev, docker-compose.prod.yml = prod)
if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    notify-send -u low "Pequod" "Starting Docker services..." -t 4000
    (cd "$PROJECT_DIR" && docker compose up -d) || {
        notify-send -u critical "Pequod" "Failed to start Docker services" -t 5000
        exit 1
    }

    # Wait for services to be healthy
    MAX_WAIT=60  # Maximum wait time in seconds
    ELAPSED=0
    WAITING_NOTIFIED=false

    while [ $ELAPSED -lt $MAX_WAIT ]; do
        # Check if all services with health checks are healthy
        UNHEALTHY=$(cd "$PROJECT_DIR" && docker compose ps --format json | jq -r 'select(.Health != "" and .Health != "healthy") | .Service' 2>/dev/null)

        if [ -z "$UNHEALTHY" ]; then
            break
        fi

        # Only show waiting notification if it's taking more than 4 seconds
        if [ $ELAPSED -ge 4 ] && [ "$WAITING_NOTIFIED" = false ]; then
            notify-send -u normal "Pequod" "Waiting for services..." -t 10000
            WAITING_NOTIFIED=true
        fi

        sleep 2
        ELAPSED=$((ELAPSED + 2))
    done

    if [ $ELAPSED -ge $MAX_WAIT ]; then
        notify-send -u normal "Pequod" "Services slow, opening anyway..." -t 3000
    fi
fi

# Open browser first (right side), then editor (left side)
if [ -n "$VIEW_URL" ]; then
    chromium --new-window "$VIEW_URL" 2>/dev/null &
    sleep 0.3
fi

$EDITOR "$WORKSPACE_FILE" &

notify-send -u low "Pequod" "Ready!" -t 3000
