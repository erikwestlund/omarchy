#!/bin/bash
# Launch script for r50-code-samples-site
#
# This script launches the r50-code-samples-site development environment with:
# - Workspace management (switches to target workspace)
# - Window positioning (adapts based on desktop vs laptop mode)
# - Notification system (shows progress updates)
#
# Desktop mode: Browser and editor on same workspace (browser right, editor left)
# Laptop mode: Editor on WS N, browser on WS N+1, then return to WS N
#
# Race condition prevention: Waits for windows to actually appear before
# switching workspaces to ensure correct positioning.

# === Helper Functions ===
# Check if a window of given class exists on a workspace
has_window_on_ws() {
    local ws="$1"
    local class="$2"
    hyprctl clients -j | jq -e --arg ws "$ws" --arg class "$class" \
        '.[] | select(.workspace.id == ($ws | tonumber) and (.class | ascii_downcase | contains($class | ascii_downcase)))' > /dev/null 2>&1
}

# === Project Config ===
PROJECT_NAME="r50-code-samples-site"
PROJECT_DIR="/home/erik/Projects/r50-code-samples-site"
WORKSPACE_FILE="$HOME/Omarchy/projects/r50-code-samples-site/r50-code-samples-site.code-workspace"
EDITOR="/usr/bin/code"
EDITOR_CLASS="code"
DEFAULT_WS=8
DOCKER_COMPOSE=false
VIEW_URL=""

# === Parse Arguments ===
WS=${1:-$DEFAULT_WS}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: launch [WORKSPACE]"
    echo ""
    echo "  WORKSPACE  Workspace number (default: $DEFAULT_WS)"
    echo ""
    echo "Examples:"
    echo "  launch      # Opens in workspace $DEFAULT_WS"
    echo "  launch 3    # Opens in workspace 3"
    exit 0
fi

# === Launch ===
notify-send -u low "R50 Code Samples Site" "Launching..." -t 5000

# Switch to workspace and wait for it to complete
hyprctl dispatch workspace $WS
sleep 0.3

# Start tmux session (if not already running) - run detached so it doesn't block
TMUX_SCRIPT="$HOME/Omarchy/projects/r50-code-samples-site/tmux.sh"
if [ -x "$TMUX_SCRIPT" ]; then
    "$TMUX_SCRIPT" </dev/null &
    sleep 0.5
fi

# Start Docker services (if enabled)
if [ "$DOCKER_COMPOSE" = "true" ] && [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    notify-send -u low "R50 Code Samples Site" "Starting Docker services..." -t 4000
    (cd "$PROJECT_DIR" && docker compose up -d) || {
        notify-send -u critical "R50 Code Samples Site" "Failed to start Docker services" -t 5000
        exit 1
    }

    # Wait for services to be healthy
    MAX_WAIT=60  # Maximum wait time in seconds
    ELAPSED=0
    WAITING_NOTIFIED=false

    while [ $ELAPSED -lt $MAX_WAIT ]; do
        # Check if all services with health checks are healthy
        UNHEALTHY=$(cd "$PROJECT_DIR" && docker compose ps --format json | jq -r 'select(.Health != "" and .Health != "healthy") | .Service' 2>/dev/null)

        if [ -z "$UNHEALTHY" ]; then
            break
        fi

        # Only show waiting notification if it's taking more than 4 seconds
        if [ $ELAPSED -ge 4 ] && [ "$WAITING_NOTIFIED" = false ]; then
            notify-send -u normal "R50 Code Samples Site" "Waiting for services..." -t 10000
            WAITING_NOTIFIED=true
        fi

        sleep 2
        ELAPSED=$((ELAPSED + 2))
    done

    if [ $ELAPSED -ge $MAX_WAIT ]; then
        notify-send -u normal "R50 Code Samples Site" "Services slow, opening anyway..." -t 3000
    fi
fi

MACHINE=$(cat ~/.machine 2>/dev/null)

if [ "$MACHINE" = "desktop" ]; then
    # Desktop: open browser first (right), then editor (left), both on same workspace
    if [ -n "$VIEW_URL" ] && ! has_window_on_ws "$WS" "chromium"; then
        hyprctl dispatch exec "[workspace $WS silent]" "chromium --new-window '$VIEW_URL'"

        # Wait for browser to appear before opening editor (ensures correct positioning)
        for i in {1..10}; do
            if has_window_on_ws "$WS" "chromium"; then
                break
            fi
            sleep 0.2
        done
    fi

    if ! has_window_on_ws "$WS" "$EDITOR_CLASS"; then
        hyprctl dispatch exec "[workspace $WS silent]" "$EDITOR '$WORKSPACE_FILE'"
    fi
else
    # Laptop: editor on WS, browser on WS+1 (if VIEW_URL is set)
    if ! has_window_on_ws "$WS" "$EDITOR_CLASS"; then
        # Ensure we're on the right workspace, then open editor
        hyprctl dispatch workspace $WS
        sleep 0.3
        $EDITOR "$WORKSPACE_FILE" &

        # Wait for editor window to actually appear on this workspace
        for i in {1..20}; do
            if has_window_on_ws "$WS" "$EDITOR_CLASS"; then
                break
            fi
            sleep 0.2
        done
    fi

    if [ -n "$VIEW_URL" ]; then
        BROWSER_WS=$((WS + 1))
        if ! has_window_on_ws "$BROWSER_WS" "chromium"; then
            # Switch to browser workspace, open browser, wait for it to appear
            hyprctl dispatch workspace $BROWSER_WS
            sleep 0.3
            chromium --new-window "$VIEW_URL" &

            # Wait for browser window to appear
            for i in {1..20}; do
                if has_window_on_ws "$BROWSER_WS" "chromium"; then
                    break
                fi
                sleep 0.2
            done

            # Switch back to editor workspace
            hyprctl dispatch workspace $WS
        fi
    fi
fi

notify-send -u low "R50 Code Samples Site" "Ready! Workspace $WS" -t 3000
