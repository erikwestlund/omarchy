#!/bin/bash
# Launch script for framework
# Generated by Ansible - edit the template, not this file

set -e

# Machine defaults (from ~/.config/omarchy/project-defaults.sh)
source ~/.config/omarchy/project-defaults.sh 2>/dev/null || true
DEFAULT_WS=${DEFAULT_WS:-3}
SPLIT_WS=${SPLIT_WS:-false}

# Project config
PROJECT_NAME="framework"
PROJECT_DIR="$HOME/Projects/framework"
DOCKER_COMPOSE=false
VIEW_URL=""

# Parse bool value (0/1, t/f, y/n, true/false, yes/no - case insensitive)
parse_bool() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        1|t|y|true|yes) echo "true" ;;
        0|f|n|false|no) echo "false" ;;
        *) echo "invalid" ;;
    esac
}

# Parse arguments
WS=$DEFAULT_WS
while [[ $# -gt 0 ]]; do
    case $1 in
        --ws=*)
            WS="${1#*=}"
            shift
            ;;
        --ws)
            WS="$2"
            shift 2
            ;;
        --split=*)
            SPLIT_WS=$(parse_bool "${1#*=}")
            shift
            ;;
        --split)
            if [[ -n "$2" && ! "$2" =~ ^-- ]]; then
                SPLIT_WS=$(parse_bool "$2")
                shift 2
            else
                SPLIT_WS=true
                shift
            fi
            ;;
        --no-split)
            SPLIT_WS=false
            shift
            ;;
        -h|--help)
            echo "Usage: launch [--ws N] [--split [BOOL]]"
            echo ""
            echo "Options:"
            echo "  --ws N, --ws=N     Launch in workspace N (default: $DEFAULT_WS)"
            echo "  --split [BOOL]     Split editor/view across workspaces"
            echo "                     BOOL: 0/1, t/f, true/false (default: true)"
            echo "  --no-split         Same as --split=false"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Calculate view workspace
if [ "$SPLIT_WS" = "true" ]; then
    VIEW_WS=$((WS + 1))
else
    VIEW_WS=$WS
fi

echo "Launching $PROJECT_NAME in workspace $WS..."

# Switch to editor workspace
hyprctl dispatch workspace $WS

# Start tmux session (if not already running)
TMUX_SCRIPT="$HOME/Omarchy/projects/framework/tmux.sh"
if [ -x "$TMUX_SCRIPT" ]; then
    "$TMUX_SCRIPT" </dev/null &
    sleep 0.5
fi

# Start framework-site Docker services (Laravel backend)
FRAMEWORK_SITE_DIR="$HOME/Projects/framework-site"
if [ -f "$FRAMEWORK_SITE_DIR/docker-compose.yml" ]; then
    echo "Starting framework-site Docker services..."
    (cd "$FRAMEWORK_SITE_DIR" && docker compose up -d)
fi

# Launch VS Code
echo "Opening VS Code..."
code "$PROJECT_DIR" &

# Wait for VS Code window to appear
sleep 1.5

# Move VS Code to the correct workspace (it may have opened elsewhere)
VSCODE_ADDR=$(hyprctl clients -j | jq -r --arg dir "$PROJECT_DIR" '.[] | select(.class == "code" or .class == "Code") | select(.title | contains($dir) or contains("framework")) | .address' | head -1)
if [ -n "$VSCODE_ADDR" ]; then
    hyprctl dispatch movetoworkspacesilent "$WS,address:$VSCODE_ADDR"
fi

# Return to editor workspace
hyprctl dispatch workspace $WS

echo "Done! $PROJECT_NAME launched in workspace $WS"
