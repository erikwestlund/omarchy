#!/bin/bash
# Bootstrap script for naaccord-data-depot - ensures project is ready to run
# Run this on a fresh machine or when setting up the project

set -e

# === Project Config ===
PROJECT_NAME="naaccord-data-depot"
PROJECT_DIR="/home/erik/Projects/naaccord-data-depot"
GIT_REPO="git@github.com:jhbiostatcenter/naaccord-data-depot.git"
SECRETS_DIR="$HOME/.secrets/naaccord-data-depot"

# Required secrets (relative to SECRETS_DIR -> PROJECT_DIR)
SECRETS=(
    ".env"
)

# Optional secrets (won't fail if missing)
OPTIONAL_SECRETS=(
)

echo "Bootstrapping $PROJECT_NAME..."

# === 1. Ensure repo is cloned ===
if [ -d "$PROJECT_DIR/.git" ]; then
    echo "[OK] Repository already exists at $PROJECT_DIR"
else
    echo "[...] Cloning repository..."
    mkdir -p "$(dirname "$PROJECT_DIR")"
    git clone "$GIT_REPO" "$PROJECT_DIR"
    echo "[OK] Repository cloned"
fi

# === 2. Ensure secrets are in place ===
if [ ! -d "$SECRETS_DIR" ]; then
    echo "[ERROR] Secrets directory not found: $SECRETS_DIR"
    echo "       Run 'secrets-pull' first to fetch secrets from B2"
    exit 1
fi

for secret in "${SECRETS[@]}"; do
    src="$SECRETS_DIR/$secret"
    dest="$PROJECT_DIR/$secret"

    if [ ! -f "$src" ]; then
        echo "[ERROR] Secret not found: $src"
        exit 1
    fi

    if [ -f "$dest" ]; then
        # Check if they're the same
        if cmp -s "$src" "$dest"; then
            echo "[OK] Secret already in place: $secret"
        else
            echo "[...] Updating secret: $secret"
            cp "$src" "$dest"
            chmod 600 "$dest"
            echo "[OK] Secret updated: $secret"
        fi
    else
        echo "[...] Copying secret: $secret"
        cp "$src" "$dest"
        chmod 600 "$dest"
        echo "[OK] Secret copied: $secret"
    fi
done

# Copy optional secrets if they exist
for secret in "${OPTIONAL_SECRETS[@]}"; do
    src="$SECRETS_DIR/$secret"
    dest="$PROJECT_DIR/$secret"

    if [ -f "$src" ]; then
        if [ -f "$dest" ]; then
            if cmp -s "$src" "$dest"; then
                echo "[OK] Optional secret already in place: $secret"
            else
                echo "[...] Updating optional secret: $secret"
                cp "$src" "$dest"
                chmod 600 "$dest"
                echo "[OK] Optional secret updated: $secret"
            fi
        else
            echo "[...] Copying optional secret: $secret"
            cp "$src" "$dest"
            chmod 600 "$dest"
            echo "[OK] Optional secret copied: $secret"
        fi
    else
        echo "[SKIP] Optional secret not found (skipping): $secret"
    fi
done

# === 3. Generate mock-idp certificates ===
CERT_DIR="$PROJECT_DIR/deploy/containers/mock-idp/cert"
if [ ! -f "$CERT_DIR/idp.crt" ]; then
    echo "[...] Generating mock-idp certificates..."
    "$PROJECT_DIR/deploy/containers/mock-idp/generate-certs.sh"
    echo "[OK] Certificates generated"
else
    echo "[OK] Mock-idp certificates already exist"
fi

# Ensure keys are readable by container (runs as www-data)
chmod 644 "$CERT_DIR"/*.key 2>/dev/null || true

# === 4. Build Docker images ===
if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "[...] Building Docker images..."
    (cd "$PROJECT_DIR" && docker compose build)
    echo "[OK] Docker images built"
else
    echo "[SKIP] No docker-compose.yml found"
fi

# === 5. Start services and run migrations ===
if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    echo "[...] Starting services..."
    (cd "$PROJECT_DIR" && docker compose up -d)

    # Wait for mariadb to be ready
    echo "[...] Waiting for database..."
    for i in {1..30}; do
        if docker exec naaccord-test-mariadb mariadb -u naaccord -pI4ms3cr3t -e "SELECT 1" naaccord >/dev/null 2>&1; then
            break
        fi
        sleep 2
    done

    echo "[...] Running migrations..."
    docker exec naaccord-test-web python manage.py migrate --noinput
    echo "[OK] Migrations complete"

    echo "[...] Seeding initial data..."
    docker exec naaccord-test-web python manage.py seed_init
    echo "[OK] Initial data seeded"

    echo "[...] Loading test users..."
    docker exec naaccord-test-web python manage.py load_test_users
    echo "[OK] Test users loaded"
fi

# === 6. Install Node dependencies ===
if [ -f "$PROJECT_DIR/package.json" ]; then
    echo "[...] Installing Node dependencies..."
    (cd "$PROJECT_DIR" && npm install)
    echo "[OK] Node dependencies installed"
else
    echo "[SKIP] No package.json found"
fi

echo ""
echo "Bootstrap complete! Run 'lna' to start $PROJECT_NAME."
echo ""
