#!/bin/bash
# Launch script for naaccord-data-depot

# === Helper Functions ===
# Check if a window of given class exists on a workspace
has_window_on_ws() {
    local ws="$1"
    local class="$2"
    hyprctl clients -j | jq -e --arg ws "$ws" --arg class "$class" \
        '.[] | select(.workspace.id == ($ws | tonumber) and (.class | ascii_downcase | contains($class | ascii_downcase)))' > /dev/null 2>&1
}

# === Project Config ===
PROJECT_NAME="naaccord-data-depot"
PROJECT_DIR="/home/erik/Projects/naaccord-data-depot"
WORKSPACE_FILE="$HOME/Omarchy/projects/naaccord-data-depot/naaccord-data-depot.code-workspace"
EDITOR="/usr/bin/code"
DEFAULT_WS=4
DOCKER_COMPOSE=true
VIEW_URL="http://naaccord.test"
USE_SPLIT=false

# === Parse Arguments ===
WS=${1:-$DEFAULT_WS}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: launch [WORKSPACE]"
    echo ""
    echo "  WORKSPACE  Workspace number (default: $DEFAULT_WS)"
    echo ""
    echo "Examples:"
    echo "  launch      # Opens in workspace $DEFAULT_WS"
    echo "  launch 3    # Opens in workspace 3"
    exit 0
fi

# === Launch ===
echo "Launching $PROJECT_NAME in workspace $WS..."

# Switch to workspace
hyprctl dispatch workspace $WS

# Start Docker services (docker-compose.yml = dev, docker-compose.prod.yml = prod)
if [ "$DOCKER_COMPOSE" = "true" ]; then
    if [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
        echo "Starting Docker services..."
        (cd "$PROJECT_DIR" && docker compose up -d) || echo "Warning: Docker compose failed - continuing anyway"
    fi
fi

# Launch editor (skip if already open on workspace)
if has_window_on_ws "$WS" "code"; then
    echo "Editor already open on workspace $WS, skipping..."
else
    echo "Opening $EDITOR..."
    hyprctl dispatch exec "[workspace $WS silent]" "$EDITOR '$WORKSPACE_FILE'"
fi

# Open browser (skip if already open on workspace)
if [ -n "$VIEW_URL" ]; then
    echo "Waiting for services to start..."
    sleep 3

    if [ "$USE_SPLIT" = "true" ]; then
        VIEW_WS=$((WS + 1))
        if has_window_on_ws "$VIEW_WS" "chromium"; then
            echo "Browser already open on workspace $VIEW_WS, skipping..."
        else
            echo "Opening view in workspace $VIEW_WS..."
            hyprctl dispatch exec "[workspace $VIEW_WS silent]" "chromium --new-window '$VIEW_URL'"
        fi
    else
        if has_window_on_ws "$WS" "chromium"; then
            echo "Browser already open on workspace $WS, skipping..."
        else
            echo "Opening view..."
            hyprctl dispatch exec "[workspace $WS silent]" "chromium --new-window '$VIEW_URL'"
        fi
    fi
fi

echo "Done! $PROJECT_NAME launched in workspace $WS"
